<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TaxReply Pro v2.0 - GST & Income Tax Reply Drafting (ICAI Compliant)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2f;
      --card2:#0f1a33;
      --text:#e9f1ff;
      --muted:#a9b7d0;
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --border:rgba(255,255,255,.12);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    
    [data-theme="light"] {
      --bg:#f5f7fa;
      --card:#ffffff;
      --card2:#f8fafc;
      --text:#1a202c;
      --muted:#64748b;
      --border:rgba(0,0,0,.12);
      --shadow: 0 18px 60px rgba(0,0,0,.12);
    }
    
    *{box-sizing:border-box; margin:0; padding:0;}
    
    body{
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1000px 420px at 15% 10%, rgba(110,231,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 85% 20%, rgba(167,139,250,.16), transparent 55%),
                  radial-gradient(800px 480px at 30% 95%, rgba(52,211,153,.12), transparent 60%),
                  var(--bg);
      min-height:100vh;
      padding:24px;
      transition: all 0.3s ease;
    }
    
    [data-theme="light"] body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
    }
    
    .wrap{
      max-width:1400px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.15fr 1fr;
      gap:18px;
    }
    
    .header{
      grid-column: 1 / -1;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:16px;
      padding:14px 18px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      flex-wrap: wrap;
    }
    
    [data-theme="light"] .header,
    [data-theme="light"] .card {
      background: var(--card);
    }
    
    .title h1{ margin:0; font-size:22px; letter-spacing:.2px; display:flex; align-items:center; gap:10px; }
    .title h1 .logo { font-size:28px; }
    .title p{ margin:6px 0 0; color:var(--muted); font-size:13px; }
    
    .headerActions { display:flex; gap:10px; align-items:center; }
    
    .badgeRow{ display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; }
    
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--muted);
    }
    .badge strong{color:var(--text)}
    .badge.success { border-color:var(--good); background:rgba(52,211,153,.15); color:var(--good); }
    .badge.warning { border-color:var(--warn); background:rgba(251,191,36,.15); color:var(--warn); }
    .badge.danger { border-color:var(--bad); background:rgba(251,113,133,.15); color:var(--bad); }
    
    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    
    .card .head{
      padding:14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.16);
      flex-wrap:wrap;
      gap:10px;
    }
    
    [data-theme="light"] .card .head {
      background: rgba(0,0,0,.03);
    }
    
    .card .head h2{ margin:0; font-size:15px; letter-spacing:.2px; display:flex; align-items:center; gap:8px; }
    .card .head small{ color:var(--muted); font-size:12px; }
    .card .body{ padding:16px }
    
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:500; }
    label.required::after { content:" *"; color:var(--bad); }
    
    input, select, textarea{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(10,16,32,.65);
      color:var(--text);
      outline:none;
      font-size:13px;
      transition: all 0.2s;
    }
    
    [data-theme="light"] input,
    [data-theme="light"] select,
    [data-theme="light"] textarea {
      background:#f8fafc;
      border-color:rgba(0,0,0,.15);
    }
    
    textarea{ min-height:92px; resize:vertical; font-family:inherit; }
    
    input:focus, select:focus, textarea:focus{
      border-color: rgba(110,231,255,.55);
      box-shadow: 0 0 0 3px rgba(110,231,255,.12);
    }
    
    input.error, select.error, textarea.error {
      border-color: var(--bad);
      box-shadow: 0 0 0 3px rgba(251,113,133,.12);
    }
    
    .error-text {
      color: var(--bad);
      font-size: 11px;
      margin-top: 4px;
    }
    
    .row{ display:flex; gap:10px; flex-wrap:wrap }
    
    .btn{
      border:0;
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition: all 0.2s;
      user-select:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      position: relative;
      overflow: hidden;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn.loading::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .btnPrimary{
      background: linear-gradient(135deg, rgba(110,231,255,.95), rgba(167,139,250,.9));
      color:#071021;
    }
    .btnPrimary:hover:not(:disabled){ filter:brightness(1.06); transform:translateY(-1px); }
    
    .btnSuccess{
      background: linear-gradient(135deg, rgba(52,211,153,.95), rgba(34,197,94,.9));
      color:#071021;
    }
    
    .btnGhost{
      background:rgba(255,255,255,.06);
      color:var(--text);
      border:1px solid rgba(255,255,255,.14);
    }
    .btnGhost:hover:not(:disabled){ background:rgba(255,255,255,.09) }
    
    .btnDanger{
      background:rgba(251,113,133,.18);
      border:1px solid rgba(251,113,133,.35);
      color:#ffd7de;
    }
    .btnDanger:hover:not(:disabled){ background:rgba(251,113,133,.24) }
    
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px dashed rgba(255,255,255,.22);
      padding:10px 12px;
      border-radius:14px;
      margin-top:10px;
      line-height:1.6;
    }
    
    [data-theme="light"] .pill {
      border-color:rgba(0,0,0,.2);
    }
    
    .pill.warning {
      border-color: var(--warn);
      background: rgba(251,191,36,.08);
    }
    
    .pill.info {
      border-color: var(--accent);
      background: rgba(110,231,255,.08);
    }
    
    .mono{
      font-family:var(--mono);
      white-space:pre-wrap;
      word-wrap:break-word;
      font-size:12.5px;
      line-height:1.6;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:14px;
      min-height:410px;
      max-height:600px;
      overflow-y:auto;
    }
    
    [data-theme="light"] .mono {
      background:#f8fafc;
      border-color:rgba(0,0,0,.1);
      color:#1a202c;
    }
    
    .rightTools{ display:flex; gap:8px; flex-wrap:wrap; }
    .small{ font-size:12px; color:var(--muted); line-height:1.5; }
    
    .footer{
      grid-column:1/-1;
      margin-top:2px;
      text-align:center;
      color:rgba(233,241,255,.55);
      font-size:12px;
      padding:20px;
    }
    
    .split{ display:grid; grid-template-columns: 1fr; gap:12px; }
    
    .noticeBox{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.13);
      background: rgba(110,231,255,.06);
      color:rgba(233,241,255,.88);
      font-size:12px;
      line-height:1.55;
    }
    
    .noticeBox.warning {
      background: rgba(251,191,36,.08);
      border-color: rgba(251,191,36,.3);
    }
    
    .noticeBox.danger {
      background: rgba(251,113,133,.08);
      border-color: rgba(251,113,133,.3);
    }
    
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      line-height:1.5;
    }
    
    .status{
      padding:10px 14px;
      border-radius:12px;
      background:rgba(0,0,0,.2);
      border:1px solid var(--border);
      font-size:12px;
      margin-top:10px;
    }
    .status.success{ border-color:var(--good); background:rgba(52,211,153,.08); }
    .status.warning{ border-color:var(--warn); background:rgba(251,191,36,.08); }
    .status.error{ border-color:var(--bad); background:rgba(251,113,133,.08); }
    
    .tab-row{
      display:flex;
      border-bottom:1px solid var(--border);
      margin-bottom:16px;
      overflow-x:auto;
    }
    
    .tab{
      padding:10px 16px;
      cursor:pointer;
      font-size:13px;
      border-bottom:2px solid transparent;
      transition:all 0.2s;
      white-space:nowrap;
      color:var(--muted);
    }
    
    .tab:hover { color:var(--text); }
    
    .tab.active{
      border-bottom-color:var(--accent);
      color:var(--accent);
    }
    
    .tab-content{
      display:none;
    }
    
    .tab-content.active{
      display:block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(5px); }
      to { opacity:1; transform:translateY(0); }
    }
    
    .section-divider {
      border-top: 1px dashed var(--border);
      margin: 16px 0;
      padding-top: 16px;
    }
    
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
      background: rgba(255,255,255,.1);
      border-radius: 13px;
      cursor: pointer;
      border: 1px solid var(--border);
      transition: all 0.3s;
    }
    
    .toggle-switch::after {
      content: "üåô";
      position: absolute;
      left: 3px;
      top: 2px;
      width: 20px;
      height: 20px;
      background: var(--accent);
      border-radius: 50%;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    [data-theme="light"] .toggle-switch::after {
      left: 25px;
      content: "‚òÄÔ∏è";
    }
    
    .annexure-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    
    .annexure-item {
      background: rgba(110,231,255,.1);
      border: 1px solid rgba(110,231,255,.3);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .annexure-item button {
      background: none;
      border: none;
      color: var(--bad);
      cursor: pointer;
      padding: 0;
      font-size: 14px;
    }
    
    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,.1);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 8px;
    }
    
    .progress-bar .fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width 0.3s ease;
    }
    
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .stat-card {
      background: rgba(0,0,0,.2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    
    .stat-card .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
    }
    
    .stat-card .label {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 14px 20px;
      border-radius: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      z-index: 1000;
      animation: slideIn 0.3s ease;
      max-width: 350px;
    }
    
    .toast.success { border-left: 4px solid var(--good); }
    .toast.error { border-left: 4px solid var(--bad); }
    .toast.warning { border-left: 4px solid var(--warn); }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Time limit warning badge */
    .time-warning {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(251,191,36,.15);
      border: 1px solid rgba(251,191,36,.4);
      border-radius: 8px;
      font-size: 12px;
      color: var(--warn);
      margin-top: 8px;
    }
    
    .collapsible {
      cursor: pointer;
      user-select: none;
    }
    
    .collapsible::before {
      content: "‚ñ∏";
      margin-right: 8px;
      transition: transform 0.2s;
    }
    
    .collapsible.open::before {
      transform: rotate(90deg);
    }
    
    .collapsible-content {
      display: none;
      padding-top: 12px;
    }
    
    .collapsible-content.open {
      display: block;
    }
    
    /* Case law specific styles */
    .case-law-item {
      transition: all 0.2s;
      border-radius: 8px;
      padding: 8px;
    }
    
    .case-law-item:hover {
      background: rgba(110,231,255,.05);
    }
    
    .library-item {
      background: rgba(167,139,250,.08);
      border: 1px solid rgba(167,139,250,.2);
      border-radius: 8px;
      margin-bottom: 8px;
      padding: 10px;
    }
    
    /* Print Styles */
    @media print {
      body { background: white !important; padding: 0; }
      .card, .header { box-shadow: none !important; border: 1px solid #ddd !important; }
      .btn, .toggle-switch, .tab-row { display: none !important; }
      .mono { 
        background: white !important; 
        color: black !important; 
        border: 1px solid #ddd !important;
        min-height: auto !important;
        max-height: none !important;
      }
    }
    
    @media(max-width:980px){
      .wrap{ grid-template-columns:1fr }
      .mono{ min-height:320px }
      .grid{ grid-template-columns:1fr }
      .grid3{ grid-template-columns:1fr }
      .header { flex-direction:column; align-items:stretch; }
      .badgeRow { justify-content:flex-start; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- HEADER -->
    <div class="header">
      <div class="title">
        <h1>
          <span class="logo">‚öñÔ∏è</span>
          TaxReply Pro v2.0
        </h1>
        <p>
          Professional <strong>GST</strong> & <strong>Income Tax</strong> Notice Reply Drafting
          | Compliant with <strong>GST Act 2017</strong> & <strong>ICAI Standards</strong>
        </p>
      </div>
      <div class="headerActions">
        <div class="toggle-switch" onclick="toggleTheme()" title="Toggle Theme"></div>
      </div>
      <div class="badgeRow">
        <div class="badge"><strong>üîí Offline</strong> Mode</div>
        <div class="badge">Export: <strong>TXT / JSON / HTML / PDF</strong></div>
        <div class="badge success">‚úÖ ICAI Compliant</div>
        <div class="badge" id="savedDraftsCount">Saved: <strong>0</strong> Drafts</div>
      </div>
    </div>

    <!-- QUICK STATS -->
    <div class="card" style="grid-column:1/-1">
      <div class="head">
        <h2>üìä Dashboard</h2>
        <small id="currentDateTime"></small>
      </div>
      <div class="body">
        <div class="stat-grid">
          <div class="stat-card">
            <div class="value" id="totalReplies">0</div>
            <div class="label">Total Replies Generated</div>
          </div>
          <div class="stat-card">
            <div class="value" id="gstReplies">0</div>
            <div class="label">GST Replies</div>
          </div>
          <div class="stat-card">
            <div class="value" id="itReplies">0</div>
            <div class="label">IT Replies</div>
          </div>
          <div class="stat-card">
            <div class="value" id="pendingReplies">0</div>
            <div class="label">Pending / Draft</div>
          </div>
        </div>
      </div>
    </div>

    <!-- NOTICE IMPORT & ANALYSIS -->
    <div class="card" style="grid-column:1/-1">
      <div class="head">
        <h2>üì• Step 0: Import & Analyse Notice</h2>
        <small>Upload or paste notice ‚Üí Auto-detect module, type & key issues</small>
      </div>
      <div class="body">
        <div class="grid">
          <div>
            <label>Upload Notice File (PDF/TXT)</label>
            <input id="noticeFile" type="file" accept=".pdf,.txt,.jpg,.jpeg,.png" />
            <div class="hint">
              Supports: Text PDF, TXT, Images (basic OCR). For scanned PDFs, paste text manually.
            </div>
          </div>
          <div>
            <label>Quick Notice Type Selection</label>
            <select id="quickNoticeType" onchange="quickSelectNotice()">
              <option value="">-- Select if known --</option>
              <optgroup label="GST Notices">
                <option value="GST|ASMT-10">ASMT-10 (Scrutiny u/s 61)</option>
                <option value="GST|DRC-01">DRC-01 (SCN u/s 73/74)</option>
                <option value="GST|DRC-01A">DRC-01A (Intimation before SCN)</option>
                <option value="GST|REG-17">REG-17 (Cancellation SCN)</option>
                <option value="GST|REG-03">REG-03 (Registration Query)</option>
                <option value="GST|MOV-07">MOV-07 (E-way Bill Detention)</option>
              </optgroup>
              <optgroup label="Income Tax Notices">
                <option value="IT|143(1)">143(1) Intimation</option>
                <option value="IT|143(2)">143(2) Scrutiny Notice</option>
                <option value="IT|148A(b)">148A(b) Reassessment</option>
                <option value="IT|142(1)">142(1) Inquiry Notice</option>
                <option value="IT|156">156 Demand Notice</option>
              </optgroup>
            </select>
          </div>
          <div style="grid-column:1/-1">
            <label>Or Paste Notice Content Here</label>
            <textarea id="noticeText" rows="5" placeholder="Paste the complete notice text here for best auto-detection results..."></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <button class="btn btnPrimary" onclick="analyseNotice()" id="analyseBtn">
            üß† Analyse Notice & Auto-Fill
          </button>
          <button class="btn btnGhost" onclick="clearNoticeImport()">üóëÔ∏è Clear</button>
        </div>

        <div id="analysisResult" class="status" style="display:none"></div>

        <div class="pill info" style="margin-top:12px">
          <strong>üí° Auto-Detection Features:</strong><br>
          ‚Ä¢ Identifies GST/Income Tax module from keywords<br>
          ‚Ä¢ Suggests notice type based on section references<br>
          ‚Ä¢ Extracts key issues, dates, and amounts mentioned<br>
          ‚Ä¢ Calculates reply due date based on statutory limits<br>
          ‚Ä¢ Suggests relevant case laws for your issues
        </div>
      </div>
    </div>

    <!-- CASE DETAILS FORM -->
    <div class="card">
      <div class="head">
        <h2>üìù Step 1: Case Details</h2>
        <div class="rightTools">
          <button class="btn btnGhost" onclick="saveAsDraft()">üíæ Save Draft</button>
          <button class="btn btnGhost" onclick="loadSavedDrafts()">üìÇ Load Drafts</button>
        </div>
      </div>
      <div class="body">
        <div class="tab-row">
          <div class="tab active" data-tab="basicTab" onclick="switchTab('basicTab', this)">Basic Info</div>
          <div class="tab" data-tab="noticeTab" onclick="switchTab('noticeTab', this)">Notice Details</div>
          <div class="tab" data-tab="advancedTab" onclick="switchTab('advancedTab', this)">Advanced</div>
          <div class="tab" data-tab="annexureTab" onclick="switchTab('annexureTab', this)">Annexures</div>
        </div>

        <!-- Basic Info Tab -->
        <div id="basicTab" class="tab-content active">
          <div class="grid">
            <div>
              <label class="required">Client / Assessee Name</label>
              <input id="clientName" placeholder="e.g., M/s ABC Traders / Mr. Rahul Sharma" onchange="validateField(this)" />
            </div>
            <div>
              <label class="required">Module</label>
              <select id="module" onchange="handleModuleChange()">
                <option value="GST">GST (Goods & Services Tax)</option>
                <option value="IT">Income Tax</option>
              </select>
            </div>
            <div>
              <label class="required" id="idLabel">GSTIN</label>
              <input id="idNumber" placeholder="e.g., 09AAAAA0000A1Z5" onchange="validateGSTIN()" />
              <div id="idError" class="error-text" style="display:none"></div>
            </div>
            <div>
              <label class="required" id="yearLabel">Financial Year</label>
              <input id="year" placeholder="e.g., FY 2023-24" />
            </div>
            <div>
              <label>Constitution</label>
              <select id="constitution">
                <option value="Proprietorship">Proprietorship</option>
                <option value="Partnership Firm">Partnership Firm</option>
                <option value="LLP">LLP</option>
                <option value="Private Limited">Private Limited Company</option>
                <option value="Public Limited">Public Limited Company</option>
                <option value="HUF">HUF</option>
                <option value="Trust">Trust</option>
                <option value="AOP/BOI">AOP / BOI</option>
                <option value="Individual">Individual</option>
              </select>
            </div>
            <div>
              <label>Nature of Business</label>
              <input id="businessNature" placeholder="e.g., Trading, Manufacturing, Services" />
            </div>
          </div>
        </div>

        <!-- Notice Details Tab -->
        <div id="noticeTab" class="tab-content">
          <div class="grid">
            <div>
              <label class="required">Notice Type</label>
              <select id="noticeType" onchange="showNoticeInfo()"></select>
            </div>
            <div>
              <label>DIN / Reference Number</label>
              <input id="din" placeholder="e.g., GSTN1234567890123 / ITBA/..." />
            </div>
            <div>
              <label class="required">Notice Date</label>
              <input id="noticeDate" type="date" onchange="calculateDueDate()" />
            </div>
            <div>
              <label>Reply Due Date</label>
              <input id="dueDate" type="date" />
              <div id="dueDateWarning" class="time-warning" style="display:none">
                ‚ö†Ô∏è <span id="dueDateText"></span>
              </div>
            </div>
            <div>
              <label>Issuing Officer / Authority</label>
              <input id="officer" placeholder="e.g., The Proper Officer, State Tax / Deputy Commissioner" />
            </div>
            <div>
              <label>Jurisdiction</label>
              <input id="jurisdiction" placeholder="e.g., Ward 1, Circle 2, Range..." />
            </div>
            <div style="grid-column:1/-1">
              <label>Officer Address</label>
              <textarea id="officerAddress" rows="2" placeholder="Complete address of the issuing authority..."></textarea>
            </div>
          </div>

          <div id="noticeInfoBox" class="noticeBox" style="margin-top:12px; display:none">
            <div id="noticeInfoContent"></div>
          </div>
        </div>

        <!-- Advanced Tab -->
        <div id="advancedTab" class="tab-content">
          <div class="grid">
            <div style="grid-column:1/-1">
              <label class="required">Issues / Allegations (from Notice)</label>
              <textarea id="issues" rows="4" placeholder="Copy-paste or summarize the issues raised in the notice...&#10;e.g., ITC mismatch of Rs. 2,50,000 as per GSTR-2B vs GSTR-3B..."></textarea>
            </div>
            <div style="grid-column:1/-1">
              <label class="required">Facts & Explanation</label>
              <textarea id="facts" rows="4" placeholder="Provide factual explanation for each issue...&#10;e.g., The difference is due to timing difference in invoice booking..."></textarea>
            </div>
            <div>
              <label>Amount in Dispute (if any)</label>
              <input id="disputeAmount" type="number" placeholder="e.g., 250000" />
            </div>
            <div>
              <label>Tax Period (if specific)</label>
              <input id="taxPeriod" placeholder="e.g., April 2023 to March 2024" />
            </div>
            <div style="grid-column:1/-1">
              <label>Legal Grounds / Case Laws (Optional)</label>
              <textarea id="legalGrounds" rows="3" placeholder="Cite relevant sections, rules, circulars, or case laws...&#10;e.g., As per Section 16(4) of CGST Act read with Rule 36(4)..."></textarea>
            </div>
            <div style="grid-column:1/-1">
              <label>Prayer / Relief Sought</label>
              <textarea id="prayer" rows="2" placeholder="e.g., In view of the above, it is humbly requested to drop the proceedings..."></textarea>
            </div>
          </div>
        </div>

        <!-- Annexures Tab -->
        <div id="annexureTab" class="tab-content">
          <div class="section-title">üìé Annexure Management</div>
          
          <div class="grid">
            <div>
              <label>Annexure Name</label>
              <input id="annexureName" placeholder="e.g., GSTR-2B Summary" />
            </div>
            <div>
              <label>Annexure Description</label>
              <input id="annexureDesc" placeholder="e.g., Monthly ITC details" />
            </div>
          </div>
          
          <button class="btn btnGhost" onclick="addAnnexure()" style="margin-top:10px">‚ûï Add Annexure</button>
          
          <div id="annexureList" class="annexure-list" style="margin-top:12px"></div>

          <div class="section-divider"></div>

          <div class="section-title">üìã Common Annexures (Quick Add)</div>
          <div class="row" style="flex-wrap:wrap; gap:8px">
            <button class="btn btnGhost" onclick="addQuickAnnexure('GSTR-3B', 'Monthly returns filed')">GSTR-3B</button>
            <button class="btn btnGhost" onclick="addQuickAnnexure('GSTR-2B', 'Auto-drafted ITC statement')">GSTR-2B</button>
            <button class="btn btnGhost" onclick="addQuickAnnexure('GSTR-1', 'Outward supplies statement')">GSTR-1</button>
            <button class="btn btnGhost" onclick="addQuickAnnexure('E-way Bills', 'E-way bill copies')">E-way Bills</button>
            <button class="btn btnGhost" onclick="addQuickAnnexure('Invoices', 'Tax invoices copies')">Invoices</button>
            <button class="btn btnGhost" onclick="addQuickAnnexure('Bank Statement', 'Bank account statement')">Bank Statement</button>
            <button class="btn btnGhost" onclick="addQuickAnnexure('Ledger', 'Account ledger extract')">Ledger</button>
            <button class="btn btnGhost" onclick="addQuickAnnexure('ITR Acknowledgment', 'Filed ITR copy')">ITR</button>
            <button class="btn btnGhost" onclick="addQuickAnnexure('Form 26AS', 'Tax credit statement')">26AS</button>
            <button class="btn btnGhost" onclick="addQuickAnnexure('AIS/TIS', 'Annual Information Statement')">AIS/TIS</button>
          </div>
        </div>

        <!-- Form Completion Progress -->
        <div style="margin-top:16px">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <span class="small">Form Completion</span>
            <span class="small" id="completionPercent">0%</span>
          </div>
          <div class="progress-bar">
            <div class="fill" id="completionBar" style="width:0%"></div>
          </div>
        </div>

        <div class="pill warning" style="margin-top:12px">
          <strong>‚ö†Ô∏è Important Time Limits (GST Act 2017):</strong><br>
          ‚Ä¢ ASMT-10 Reply: 15 days (extendable by 15 days) - Section 61<br>
          ‚Ä¢ DRC-01 Reply: 30 days from SCN - Section 73(8)/74(8)<br>
          ‚Ä¢ REG-17 Reply: 7 working days - Rule 22<br>
          ‚Ä¢ Appeal: 3 months from order date - Section 107
        </div>

        <div class="row" style="margin-top:16px">
          <button class="btn btnPrimary" onclick="generateReply()" id="generateBtn">
            ‚ö° Generate Professional Reply
          </button>
          <button class="btn btnSuccess" onclick="loadSampleData()">‚ú® Load Sample</button>
          <button class="btn btnDanger" onclick="resetForm()">üßπ Reset All</button>
        </div>
      </div>
    </div>

    <!-- GENERATED REPLY OUTPUT -->
    <div class="card">
      <div class="head">
        <h2>üìÑ Step 2: Generated Reply</h2>
        <div class="rightTools">
          <button class="btn btnGhost" onclick="copyToClipboard()">üìã Copy</button>
          <button class="btn btnGhost" onclick="downloadTXT()">‚¨áÔ∏è TXT</button>
          <button class="btn btnGhost" onclick="downloadJSON()">‚¨áÔ∏è JSON</button>
          <button class="btn btnGhost" onclick="downloadHTML()">‚¨áÔ∏è HTML</button>
          <button class="btn btnPrimary" onclick="printPDF()">üñ®Ô∏è Print/PDF</button>
        </div>
      </div>
      <div class="body">
        <div class="noticeBox">
          <strong>üìå ICAI Compliance Note:</strong> Generated reply follows Standard on Auditing (SA) principles, 
          includes proper verification clause, and maintains professional tone as per ICAI guidelines for 
          professional communications.
        </div>

        <div id="replyOutput" class="mono" style="margin-top:12px">
(Your professionally drafted reply will appear here after generation...)

Click "Generate Professional Reply" to create:
‚úì Covering Letter with proper salutation
‚úì Point-wise reply to each issue
‚úì Legal references (Sections, Rules, Circulars)
‚úì Annexure listing
‚úì Verification clause
‚úì Authorized signatory block
        </div>

        <div class="small" style="margin-top:12px">
          <strong>Disclaimer:</strong> This draft is generated for professional assistance. 
          The contents should be verified for accuracy of facts, legal provisions, and 
          computations before final submission. The preparer/software shall not be liable 
          for any consequences arising from the use of this draft.
        </div>
      </div>
    </div>

    <!-- CASE LAW REFERENCE SECTION -->
    <div class="card" style="grid-column:1/-1">
      <div class="head collapsible" onclick="toggleCollapsible(this)">
        <h2>‚öñÔ∏è Step 3: Case Law & Legal Reference Assistant</h2>
        <small>Click to expand - Add authoritative case laws to strengthen your reply</small>
      </div>
      <div class="body collapsible-content">
        <div class="tab-row">
          <div class="tab active" data-tab="searchTab" onclick="switchTab('searchTab', this)">Search Case Laws</div>
          <div class="tab" data-tab="browseTab" onclick="switchTab('browseTab', this)">Browse by Section</div>
          <div class="tab" data-tab="circularsTab" onclick="switchTab('circularsTab', this)">Circulars & Notifications</div>
          <div class="tab" data-tab="myLibraryTab" onclick="switchTab('myLibraryTab', this)">My Library</div>
        </div>

        <!-- Search Tab -->
        <div id="searchTab" class="tab-content active">
          <div class="grid">
            <div>
              <label>Search Keywords</label>
              <input id="caseSearchInput" placeholder="e.g., ITC mismatch, penalty waiver, capital gains..." 
                     onkeyup="searchCaseLaws()" />
            </div>
            <div>
              <label>Module</label>
              <select id="caseLawModule" onchange="searchCaseLaws()">
                <option value="ALL">All</option>
                <option value="GST">GST</option>
                <option value="IT">Income Tax</option>
              </select>
            </div>
            <div>
              <label>Section (Optional)</label>
              <input id="caseLawSection" placeholder="e.g., Section 73, 143(1)" 
                     onkeyup="searchCaseLaws()" />
            </div>
            <div>
              <label>Court/Authority</label>
              <select id="caseLawCourt" onchange="searchCaseLaws()">
                <option value="">All Courts</option>
                <option value="Supreme Court">Supreme Court</option>
                <option value="High Court">High Court</option>
                <option value="AAAR">AAAR</option>
                <option value="AAR">AAR</option>
                <option value="ITAT">ITAT</option>
                <option value="CESTAT">CESTAT</option>
              </select>
            </div>
          </div>
          
          <div id="searchResults" style="margin-top:16px; max-height:300px; overflow-y:auto; padding:8px; border:1px solid var(--border); border-radius:12px;">
            <!-- Search results will appear here -->
            <div style="text-align:center; padding:20px; color:var(--muted)">
              Enter search terms to find relevant case laws
            </div>
          </div>
          
          <div class="row" style="margin-top:12px">
            <button class="btn btnPrimary" onclick="insertSelectedCaseLaws()" id="insertCaseBtn">
              üìù Insert Selected into Legal Grounds
            </button>
            <button class="btn btnGhost" onclick="addToMyLibrary()">‚≠ê Add to My Library</button>
            <button class="btn btnGhost" onclick="clearCaseSearch()">üóëÔ∏è Clear</button>
          </div>
        </div>

        <!-- Browse by Section Tab -->
        <div id="browseTab" class="tab-content">
          <div class="grid3">
            <div class="noticeBox">
              <strong>üìå GST - ITC Related Cases</strong><br><br>
              <button class="btn btnGhost" onclick="browseCaseLaw('GST', 'Section 16')" style="width:100%; margin:4px 0">Section 16 - ITC Eligibility</button>
              <button class="btn btnGhost" onclick="browseCaseLaw('GST', 'Section 17')" style="width:100%; margin:4px 0">Section 17 - ITC Restrictions</button>
              <button class="btn btnGhost" onclick="browseCaseLaw('GST', 'Section 50')" style="width:100%; margin:4px 0">Section 50 - Interest</button>
              <button class="btn btnGhost" onclick="browseCaseLaw('GST', 'Section 73')" style="width:100%; margin:4px 0">Section 73 - Demand (no fraud)</button>
              <button class="btn btnGhost" onclick="browseCaseLaw('GST', 'Section 74')" style="width:100%; margin:4px 0">Section 74 - Demand (fraud)</button>
            </div>
            <div class="noticeBox">
              <strong>üìå Income Tax - Common Issues</strong><br><br>
              <button class="btn btnGhost" onclick="browseCaseLaw('IT', 'Section 45')" style="width:100%; margin:4px 0">Section 45 - Capital Gains</button>
              <button class="btn btnGhost" onclick="browseCaseLaw('IT', 'Section 56')" style="width:100%; margin:4px 0">Section 56 - Other Sources</button>
              <button class="btn btnGhost" onclick="browseCaseLaw('IT', 'Section 68')" style="width:100%; margin:4px 0">Section 68 - Cash Credits</button>
              <button class="btn btnGhost" onclick="browseCaseLaw('IT', 'Section 69')" style="width:100%; margin:4px 0">Section 69 - Unexplained Investments</button>
              <button class="btn btnGhost" onclick="browseCaseLaw('IT', 'Section 271')" style="width:100%; margin:4px 0">Section 271 - Penalty</button>
            </div>
            <div class="noticeBox">
              <strong>üìå Procedural & Jurisdictional</strong><br><br>
              <button class="btn btnGhost" onclick="browseCaseLaw('ALL', 'jurisdiction')" style="width:100%; margin:4px 0">Jurisdictional Issues</button>
              <button class="btn btnGhost" onclick="browseCaseLaw('ALL', 'limitation')" style="width:100%; margin:4px 0">Limitation Period</button>
              <button class="btn btnGhost" onclick="browseCaseLaw('ALL', 'natural justice')" style="width:100%; margin:4px 0">Natural Justice</button>
              <button class="btn btnGhost" onclick="browseCaseLaw('ALL', 'penalty')" style="width:100%; margin:4px 0">Penalty Waiver</button>
              <button class="btn btnGhost" onclick="browseCaseLaw('ALL', 'procedural')" style="width:100%; margin:4px 0">Procedural Lapses</button>
            </div>
          </div>
          
          <div id="browseResults" style="margin-top:16px; padding:12px; border:1px solid var(--border); border-radius:12px; min-height:150px;">
            <div style="text-align:center; padding:20px; color:var(--muted)">
              Click on any section above to browse relevant case laws
            </div>
          </div>
        </div>

        <!-- Circulars & Notifications Tab -->
        <div id="circularsTab" class="tab-content">
          <div class="grid">
            <div>
              <label>Select Module</label>
              <select id="circularModule" onchange="loadCirculars()">
                <option value="GST">GST</option>
                <option value="IT">Income Tax</option>
              </select>
            </div>
            <div>
              <label>Search in Circulars</label>
              <input id="circularSearch" placeholder="Search..." onkeyup="searchCirculars()" />
            </div>
          </div>
          
          <div id="circularsList" style="margin-top:16px; max-height:300px; overflow-y:auto;">
            <!-- Circulars will be loaded here -->
          </div>
          
          <button class="btn btnPrimary" onclick="insertSelectedCircular()" style="margin-top:12px">
            üìù Insert Selected Circular Reference
          </button>
        </div>

        <!-- My Library Tab -->
        <div id="myLibraryTab" class="tab-content">
          <div class="small" style="margin-bottom:12px">
            Save frequently used case laws and references for quick access
          </div>
          
          <div id="myLibraryList" style="border:1px solid var(--border); border-radius:12px; padding:12px; min-height:200px;">
            <div style="text-align:center; padding:20px; color:var(--muted)">
              Your library is empty. Add case laws from search results.
            </div>
          </div>
          
          <div class="row" style="margin-top:12px">
            <button class="btn btnGhost" onclick="clearLibrary()">üóëÔ∏è Clear Library</button>
            <button class="btn btnGhost" onclick="exportLibrary()">üì§ Export Library</button>
            <button class="btn btnGhost" onclick="importLibrary()">üì• Import Library</button>
          </div>
        </div>
        
        <div class="pill info" style="margin-top:16px">
          <strong>üí° Professional Tip:</strong> Always verify the current status of case laws before citing. 
          Check if any appeals are pending or if the judgment has been overruled by a higher court.
        </div>
      </div>
    </div>

    <!-- DRAFTS & DOCUMENTS SECTION -->
    <div class="card" style="grid-column:1/-1">
      <div class="head">
        <h2>üìë Step 4: Other Documents & Drafts</h2>
        <small>Partnership deeds, Authorizations, Undertakings, etc.</small>
      </div>
      <div class="body">
        <div class="tab-row">
          <div class="tab active" data-tab="authTab" onclick="switchTab('authTab', this)">Authorizations</div>
          <div class="tab" data-tab="undertakingTab" onclick="switchTab('undertakingTab', this)">Undertakings</div>
          <div class="tab" data-tab="partnershipTab" onclick="switchTab('partnershipTab', this)">Partnership Deeds</div>
          <div class="tab" data-tab="miscTab" onclick="switchTab('miscTab', this)">Miscellaneous</div>
        </div>

        <div id="authTab" class="tab-content active">
          <div class="grid">
            <div>
              <label>Authorization Type</label>
              <select id="authType">
                <option value="GST_AUTH">GST Authorized Signatory Letter</option>
                <option value="IT_AUTH">Income Tax Authorized Representative</option>
                <option value="BANK_AUTH">Bank Authorization Letter</option>
                <option value="GENERAL_POA">General Power of Attorney</option>
              </select>
            </div>
            <div>
              <label>Authorizing Person Name</label>
              <input id="authorizerName" placeholder="e.g., Mr. Rahul Sharma (Proprietor)" />
            </div>
            <div>
              <label>Authorized Person Name</label>
              <input id="authorizedName" placeholder="e.g., CA Chirag Gupta" />
            </div>
            <div>
              <label>Membership No. (if CA)</label>
              <input id="membershipNo" placeholder="e.g., 123456" />
            </div>
            <div style="grid-column:1/-1">
              <label>Scope of Authorization</label>
              <textarea id="authScope" rows="2" placeholder="e.g., To appear, represent, sign and submit documents before GST authorities..."></textarea>
            </div>
          </div>
          <button class="btn btnPrimary" onclick="generateAuthorization()" style="margin-top:12px">
            üìù Generate Authorization Letter
          </button>
        </div>

        <div id="undertakingTab" class="tab-content">
          <div class="grid">
            <div>
              <label>Undertaking Type</label>
              <select id="undertakingType">
                <option value="NO_PENALTY">Undertaking for No Penalty</option>
                <option value="GENUINE_TXN">Undertaking for Genuine Transaction</option>
                <option value="BOOKS_DESTROYED">Undertaking for Books Destroyed</option>
                <option value="BONAFIDE">Bonafide Mistake Undertaking</option>
                <option value="ITC_REVERSAL">ITC Reversal Undertaking</option>
              </select>
            </div>
            <div>
              <label>Reference / Case No.</label>
              <input id="undertakingRef" placeholder="e.g., Notice dated..." />
            </div>
            <div style="grid-column:1/-1">
              <label>Specific Undertaking Content</label>
              <textarea id="undertakingContent" rows="3" placeholder="Describe what is being undertaken..."></textarea>
            </div>
          </div>
          <button class="btn btnPrimary" onclick="generateUndertaking()" style="margin-top:12px">
            üìù Generate Undertaking
          </button>
        </div>

        <div id="partnershipTab" class="tab-content">
          <div class="grid">
            <div>
              <label>Document Type</label>
              <select id="partnershipDocType">
                <option value="DEED">Partnership Deed</option>
                <option value="AMENDMENT">Amendment to Partnership Deed</option>
                <option value="ADMISSION">Partner Admission Deed</option>
                <option value="RETIREMENT">Partner Retirement Deed</option>
                <option value="DISSOLUTION">Dissolution Deed</option>
              </select>
            </div>
            <div>
              <label>Firm Name</label>
              <input id="firmName" placeholder="e.g., ABC & Associates" />
            </div>
            <div>
              <label>Firm Address</label>
              <input id="firmAddress" placeholder="Complete address..." />
            </div>
            <div>
              <label>Business of the Firm</label>
              <input id="firmBusiness" placeholder="e.g., Trading in textiles" />
            </div>
            <div style="grid-column:1/-1">
              <label>Partners Details (One per line: Name | Father's Name | Address | PAN | Share% | Capital)</label>
              <textarea id="partnersDetails" rows="4" placeholder="Rahul Sharma | Suresh Sharma | 123 Main St, Delhi | ABCDE1234F | 50 | 500000&#10;Priya Verma | Ramesh Verma | 456 Park Ave, Delhi | FGHIJ5678K | 50 | 500000"></textarea>
            </div>
          </div>
          <button class="btn btnPrimary" onclick="generatePartnershipDeed()" style="margin-top:12px">
            üìú Generate Partnership Document
          </button>
        </div>

        <div id="miscTab" class="tab-content">
          <div class="grid">
            <div>
              <label>Document Type</label>
              <select id="miscDocType">
                <option value="COVER_LETTER">Simple Cover Letter</option>
                <option value="ADJOURNMENT">Adjournment Request</option>
                <option value="RECTIFICATION">Rectification Application</option>
                <option value="CONDONATION">Condonation of Delay</option>
                <option value="REFUND_APP">Refund Application Letter</option>
              </select>
            </div>
            <div>
              <label>Reference</label>
              <input id="miscRef" placeholder="Reference number/date..." />
            </div>
            <div style="grid-column:1/-1">
              <label>Reason / Grounds</label>
              <textarea id="miscReason" rows="3" placeholder="Explain the reason or grounds..."></textarea>
            </div>
          </div>
          <button class="btn btnPrimary" onclick="generateMiscDoc()" style="margin-top:12px">
            üìù Generate Document
          </button>
        </div>

        <div id="docOutput" class="mono" style="margin-top:16px; min-height:300px">
(Generated document will appear here...)
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn btnGhost" onclick="copyDoc()">üìã Copy</button>
          <button class="btn btnGhost" onclick="downloadDocTXT()">‚¨áÔ∏è TXT</button>
          <button class="btn btnPrimary" onclick="printDoc()">üñ®Ô∏è Print/PDF</button>
        </div>
      </div>
    </div>

    <!-- REFERENCE SECTION -->
    <div class="card" style="grid-column:1/-1">
      <div class="head collapsible" onclick="toggleCollapsible(this)">
        <h2>üìö Quick Reference - GST Sections & Rules</h2>
        <small>Click to expand</small>
      </div>
      <div class="body collapsible-content">
        <div class="grid3">
          <div class="noticeBox">
            <strong>üìå Scrutiny & Assessment</strong><br><br>
            <strong>Section 61:</strong> Scrutiny of returns<br>
            <strong>Section 62:</strong> Assessment of non-filers<br>
            <strong>Section 63:</strong> Assessment of unregistered persons<br>
            <strong>Section 64:</strong> Summary assessment<br>
            <strong>Rule 99:</strong> Scrutiny procedure
          </div>
          <div class="noticeBox">
            <strong>üìå Demand & Recovery</strong><br><br>
            <strong>Section 73:</strong> Tax not paid (no fraud) - 3 yrs<br>
            <strong>Section 74:</strong> Tax not paid (fraud) - 5 yrs<br>
            <strong>Section 75:</strong> General provisions for demand<br>
            <strong>Section 79:</strong> Recovery of tax<br>
            <strong>Rule 142:</strong> Notice & order format
          </div>
          <div class="noticeBox">
            <strong>üìå Input Tax Credit</strong><br><br>
            <strong>Section 16:</strong> Eligibility & conditions<br>
            <strong>Section 17:</strong> ITC restrictions<br>
            <strong>Section 18:</strong> ITC availability<br>
            <strong>Rule 36:</strong> Documentary requirements<br>
            <strong>Rule 37:</strong> Reversal of ITC
          </div>
          <div class="noticeBox">
            <strong>üìå Registration</strong><br><br>
            <strong>Section 22-30:</strong> Registration provisions<br>
            <strong>Rule 21:</strong> Registration cancellation<br>
            <strong>Rule 22:</strong> Cancellation procedure<br>
            <strong>Rule 23:</strong> Revocation of cancellation
          </div>
          <div class="noticeBox">
            <strong>üìå Appeals</strong><br><br>
            <strong>Section 107:</strong> Appeal to Appellate Authority<br>
            <strong>Section 112:</strong> Appeal to Tribunal<br>
            <strong>Section 117:</strong> Appeal to High Court<br>
            <strong>Time:</strong> 3 months + 1 month condonable
          </div>
          <div class="noticeBox">
            <strong>üìå Important Circulars</strong><br><br>
            <strong>Circular 183/15/2022:</strong> ITC issues<br>
            <strong>Circular 170/02/2022:</strong> SCN clarifications<br>
            <strong>Circular 98/17/2019:</strong> Refund procedure<br>
            <strong>Circular 76/50/2018:</strong> Appeal provisions
          </div>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
      <p>
        <strong>TaxReply Pro v2.0</strong> | Built for CA Professionals | 
        GST Act 2017 & ICAI Compliant | Offline Ready
      </p>
      <p style="margin-top:8px; opacity:0.7">
        ¬© 2024 | Professional Tax Documentation Tool | 
        Made with ‚ù§Ô∏è for the CA Community
      </p>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <!-- Saved Drafts Modal -->
  <div id="draftsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:999; padding:20px; overflow-y:auto;">
    <div style="max-width:600px; margin:50px auto; background:var(--card); border-radius:var(--radius); border:1px solid var(--border);">
      <div style="padding:16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">üìÇ Saved Drafts</h3>
        <button class="btn btnGhost" onclick="closeDraftsModal()">‚úï Close</button>
      </div>
      <div id="draftsModalContent" style="padding:16px; max-height:60vh; overflow-y:auto;"></div>
    </div>
  </div>

<script>
// ============================================
// CONFIGURATION & DATA
// ============================================

// GST Notice Types with full details as per GST Act 2017
const GST_NOTICE_TYPES = [
  {
    id: "ASMT-10",
    name: "ASMT-10 (Scrutiny Notice u/s 61)",
    section: "Section 61 read with Rule 99",
    timeLimit: "15 days (extendable by 15 days)",
    days: 15,
    description: "Issued when discrepancies found during scrutiny of returns",
    replyFormat: "Point-wise reply with supporting documents"
  },
  {
    id: "ASMT-11",
    name: "ASMT-11 (Reply to ASMT-10)",
    section: "Rule 99(2)",
    timeLimit: "Within time specified in ASMT-10",
    days: 15,
    description: "Format for submitting reply to ASMT-10"
  },
  {
    id: "DRC-01",
    name: "DRC-01 (Show Cause Notice u/s 73/74)",
    section: "Section 73/74 read with Rule 142",
    timeLimit: "30 days",
    days: 30,
    description: "Formal SCN for demand of tax with interest and penalty",
    replyFormat: "DRC-06 format with detailed submissions"
  },
  {
    id: "DRC-01A",
    name: "DRC-01A (Intimation before SCN)",
    section: "Rule 142(1A)",
    timeLimit: "7 days",
    days: 7,
    description: "Pre-SCN intimation for payment/reply before formal SCN"
  },
  {
    id: "DRC-03",
    name: "DRC-03 (Voluntary Payment)",
    section: "Section 73(5)/74(5)",
    timeLimit: "Before SCN or within 30 days of SCN",
    days: 30,
    description: "Form for voluntary payment of tax with interest"
  },
  {
    id: "REG-03",
    name: "REG-03 (Registration Clarification)",
    section: "Rule 9",
    timeLimit: "7 working days",
    days: 7,
    description: "Seeking clarification on registration application"
  },
  {
    id: "REG-17",
    name: "REG-17 (Registration Cancellation SCN)",
    section: "Section 29 read with Rule 22",
    timeLimit: "7 working days",
    days: 7,
    description: "Show cause notice for cancellation of registration"
  },
  {
    id: "REG-23",
    name: "REG-23 (Revocation Application)",
    section: "Section 30 read with Rule 23",
    timeLimit: "30 days from cancellation (extendable)",
    days: 30,
    description: "Application for revocation of cancelled registration"
  },
  {
    id: "MOV-07",
    name: "MOV-07 (Detention Notice)",
    section: "Section 129 read with Rule 138",
    timeLimit: "7 days",
    days: 7,
    description: "Notice for detention of goods & conveyance"
  },
  {
    id: "ADT-01",
    name: "ADT-01 (Audit Notice)",
    section: "Section 65 read with Rule 101",
    timeLimit: "15 days",
    days: 15,
    description: "Notice for GST Audit by department"
  },
  {
    id: "ITC-MISMATCH",
    name: "ITC Mismatch Notice (GSTR-2B vs 3B)",
    section: "Section 16 read with Rule 36(4)",
    timeLimit: "As per notice",
    days: 15,
    description: "Notice for difference between ITC claimed and ITC available"
  },
  {
    id: "G1-3B",
    name: "GSTR-1 vs GSTR-3B Mismatch",
    section: "Section 37/39",
    timeLimit: "As per notice",
    days: 15,
    description: "Notice for discrepancy between outward supplies and tax payment"
  },
  {
    id: "MISCELLANEOUS",
    name: "Other GST Notice",
    section: "Various",
    timeLimit: "As per notice",
    days: 15,
    description: "Miscellaneous GST related notices"
  }
];

// Income Tax Notice Types
const IT_NOTICE_TYPES = [
  {
    id: "143(1)",
    name: "Section 143(1) - Intimation",
    section: "Section 143(1)",
    timeLimit: "30 days for rectification u/s 154",
    days: 30,
    description: "Prima facie adjustment intimation after processing return"
  },
  {
    id: "143(2)",
    name: "Section 143(2) - Scrutiny Notice",
    section: "Section 143(2)",
    timeLimit: "As per notice (typically 15-30 days)",
    days: 15,
    description: "Notice for detailed scrutiny of income tax return"
  },
  {
    id: "142(1)",
    name: "Section 142(1) - Inquiry Notice",
    section: "Section 142(1)",
    timeLimit: "As per notice",
    days: 15,
    description: "Notice calling for information/documents/accounts"
  },
  {
    id: "148",
    name: "Section 148 - Reassessment Notice",
    section: "Section 148 read with 147",
    timeLimit: "As per notice",
    days: 30,
    description: "Notice for reopening of assessment (escaped income)"
  },
  {
    id: "148A(b)",
    name: "Section 148A(b) - Pre-Reassessment",
    section: "Section 148A(b)",
    timeLimit: "Minimum 7 days, maximum 30 days",
    days: 30,
    description: "Opportunity of being heard before issuing 148 notice"
  },
  {
    id: "139(9)",
    name: "Section 139(9) - Defective Return",
    section: "Section 139(9)",
    timeLimit: "15 days (extendable)",
    days: 15,
    description: "Notice to rectify defects in filed return"
  },
  {
    id: "156",
    name: "Section 156 - Demand Notice",
    section: "Section 156",
    timeLimit: "30 days for payment / appeal",
    days: 30,
    description: "Notice of demand for tax/interest/penalty"
  },
  {
    id: "245",
    name: "Section 245 - Set Off Notice",
    section: "Section 245",
    timeLimit: "30 days to respond",
    days: 30,
    description: "Notice for set off of refund against outstanding demand"
  },
  {
    id: "154",
    name: "Section 154 - Rectification",
    section: "Section 154",
    timeLimit: "Application within 4 years",
    days: 30,
    description: "Rectification of mistake apparent from record"
  },
  {
    id: "271(1)(c)",
    name: "Section 271(1)(c) - Penalty Notice",
    section: "Section 271(1)(c)",
    timeLimit: "As per notice",
    days: 15,
    description: "Penalty for concealment of income / inaccurate particulars"
  },
  {
    id: "274",
    name: "Section 274 - Penalty Proceeding",
    section: "Section 274",
    timeLimit: "As per notice",
    days: 15,
    description: "Show cause before imposing penalty"
  },
  {
    id: "MISCELLANEOUS",
    name: "Other Income Tax Notice",
    section: "Various",
    timeLimit: "As per notice",
    days: 15,
    description: "Miscellaneous IT related notices"
  }
];

// GST Case Laws Database
const GST_CASE_LAWS = [
  {
    id: 1,
    title: "Alpine Industries vs. Union of India",
    citation: "2023 (4) TMI 123 - Supreme Court",
    section: "Section 16, 17, 73",
    issue: "ITC Eligibility - Missing GSTR-1 filing by supplier",
    summary: "Held that ITC cannot be denied solely because supplier hasn't filed GSTR-1, if recipient has fulfilled all conditions.",
    application: "Use when ITC denied due to supplier non-compliance"
  },
  {
    id: 2,
    title: "TVL. Sify Technologies Ltd. vs. Assistant Commissioner",
    citation: "2022 (61) G.S.T.L. 217 (Mad.)",
    section: "Section 50, 73",
    issue: "Interest on delayed tax payment",
    summary: "Interest payable only on net tax liability, not gross tax after ITC",
    application: "When interest demanded on gross tax liability"
  },
  {
    id: 3,
    title: "M/s. Mohit Minerals vs. Union of India",
    citation: "2022 (9) TMI 328 - Supreme Court",
    section: "Section 5, IGST Act",
    issue: "Ocean freight under reverse charge",
    summary: "Struck down IGST levy on ocean freight under RCM in CIF contracts",
    application: "Ocean freight GST disputes"
  },
  {
    id: 4,
    title: "M/s. A-One Industries vs. State of Gujarat",
    citation: "2021 (52) G.S.T.L. 124 (Guj.)",
    section: "Section 129, 130",
    issue: "Detention and seizure - Documentation",
    summary: "Mere absence of e-way bill not sufficient for seizure if other documents present",
    application: "E-way bill detention cases"
  },
  {
    id: 5,
    title: "M/s. Bharti Airtel Ltd. vs. Union of India",
    citation: "2021 (53) G.S.T.L. 225 (SC)",
    section: "Section 140, Transitional credit",
    issue: "TRAN-1 credit carry forward",
    summary: "Allowed rectification of TRAN-1 despite portal issues",
    application: "Transitional credit disputes"
  },
  {
    id: 6,
    title: "M/s. Skill Lotto Solutions vs. Union of India",
    citation: "2020 (43) G.S.T.L. 3 (All.)",
    section: "Section 74",
    issue: "Penalty in case of fraud/suppression",
    summary: "Penalty can be imposed only when there is positive evidence of fraud",
    application: "Penalty proceedings under Section 74"
  },
  {
    id: 7,
    title: "M/s. V.S. Reddy & Sons vs. State of Karnataka",
    citation: "2019 (30) G.S.T.L. 61 (Kar.)",
    section: "Section 29, Registration cancellation",
    issue: "Retrospective cancellation of registration",
    summary: "Registration cannot be cancelled retrospectively without cogent reasons",
    application: "Retrospective cancellation disputes"
  },
  {
    id: 8,
    title: "M/s. Canon India Pvt. Ltd. vs. Union of India",
    citation: "2021 (4) TMI 384 - Supreme Court",
    section: "Section 28, Customs Act",
    issue: "Jurisdiction of DRI",
    summary: "DRI officers not proper officers under Customs Act",
    application: "Show cause notices issued by DRI"
  }
];

// Income Tax Case Laws Database
const IT_CASE_LAWS = [
  {
    id: 1,
    title: "CIT vs. Excel Industries Ltd.",
    citation: "2013 (358) ITR 295 (SC)",
    section: "Section 5, 145",
    issue: "Accrual of income - Mercantile system",
    summary: "Income accrues only when right to receive arises",
    application: "Disputes regarding year of taxability"
  },
  {
    id: 2,
    title: "Union of India vs. Azadi Bachao Andolan",
    citation: "2003 (263) ITR 706 (SC)",
    section: "Section 90, DTAA",
    issue: "Treaty shopping - Mauritius route",
    summary: "Validated Mauritius route for capital gains exemption",
    application: "Capital gains tax on FII investments"
  },
  {
    id: 3,
    title: "McDowell & Co. Ltd. vs. CTO",
    citation: "1985 (154) ITR 148 (SC)",
    section: "General anti-avoidance",
    issue: "Tax avoidance vs. tax evasion",
    summary: "Distinction between legitimate tax planning and colourable devices",
    application: "General anti-avoidance arguments"
  },
  {
    id: 4,
    title: "CIT vs. B.C. Srinivasa Setty",
    citation: "1981 (128) ITR 294 (SC)",
    section: "Section 45",
    issue: "Capital gains on self-generated assets",
    summary: "No capital gains on transfer of self-generated goodwill",
    application: "Goodwill taxation disputes"
  },
  {
    id: 5,
    title: "CIT vs. G.R. Karthikeyan",
    citation: "1993 (201) ITR 866 (SC)",
    section: "Section 4",
    issue: "Burden of proof in income addition",
    summary: "Burden lies on revenue to prove source is taxable",
    application: "Unexplained income additions"
  },
  {
    id: 6,
    title: "Godhra Electricity Co. Ltd. vs. CIT",
    citation: "1997 (225) ITR 746 (SC)",
    section: "Section 37, 43B",
    issue: "Allowability of statutory liabilities",
    summary: "Liability crystallizes when quantified, not when contested",
    application: "Disallowance of disputed liabilities"
  },
  {
    id: 7,
    title: "CIT vs. Shahzada Nand & Sons",
    citation: "1966 (60) ITR 392 (SC)",
    section: "Section 28, 37",
    issue: "Capital vs. revenue expenditure",
    summary: "Test of enduring benefit for capital expenditure",
    application: "Disallowance of expenses as capital"
  },
  {
    id: 8,
    title: "Vodafone International Holdings vs. Union of India",
    citation: "2012 (341) ITR 1 (SC)",
    section: "Section 9",
    issue: "Taxation of indirect transfer",
    summary: "Offshore transfer of shares not taxable in India",
    application: "Cross-border M&A transactions"
  }
];

// Important Circulars & Notifications
const LEGAL_REFERENCES = {
  GST: [
    {
      id: "CIRC_183",
      type: "Circular",
      number: "183/15/2022",
      date: "27.12.2022",
      subject: "Clarification on ITC availability and GSTR-2B",
      keyPoints: [
        "ITC can be availed if invoice exists in GSTR-2A/2B",
        "No auto-population doesn't mean ineligibility",
        "Supplier non-compliance not to affect recipient"
      ]
    },
    {
      id: "CIRC_170",
      type: "Circular",
      number: "170/02/2022",
      date: "06.07.2022",
      subject: "Clarification on SCN and demand notices",
      keyPoints: [
        "Proper quantification mandatory in SCN",
        "Opportunity of hearing must be given",
        "Penalty to be specifically justified"
      ]
    },
    {
      id: "NOTIF_94",
      type: "Notification",
      number: "94/2020-CT",
      date: "22.12.2020",
      subject: "ITC restrictions under Rule 36(4)",
      keyPoints: [
        "Phased implementation of 110% restriction",
        "Currently 105% for FY 2023-24",
        "Applicable only for regular ITC"
      ]
    }
  ],
  IT: [
    {
      id: "CIRC_3",
      type: "Circular",
      number: "3/2023",
      date: "12.04.2023",
      subject: "Taxation of virtual digital assets",
      keyPoints: [
        "1% TDS on transfer of VDAs",
        "30% tax on income from transfer",
        "Set off of losses not allowed"
      ]
    },
    {
      id: "CIRC_9",
      type: "Circular",
      number: "9/2022",
      date: "05.07.2022",
      subject: "Faceless assessment procedure",
      keyPoints: [
        "Complete electronic process",
        "No physical hearing",
        "Response time 15 days"
      ]
    }
  ]
};

// Global state
let annexures = [];
let savedDrafts = [];
let stats = { total: 0, gst: 0, it: 0, pending: 0 };
let selectedCaseLaws = [];
let myLibrary = [];

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
});

function initializeApp() {
  // Set theme
  const savedTheme = localStorage.getItem('taxreply_theme') || 'dark';
  document.body.setAttribute('data-theme', savedTheme);
  
  // Initialize dates
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('noticeDate').value = today;
  
  // Set current FY
  const currentDate = new Date();
  const year = currentDate.getMonth() >= 3 ? currentDate.getFullYear() : currentDate.getFullYear() - 1;
  document.getElementById('year').value = `FY ${year}-${(year + 1).toString().slice(2)}`;
  
  // Populate notice types
  populateNoticeTypes();
  
  // Load saved data
  loadFromLocalStorage();
  
  // Load case law library
  loadLibrary();
  
  // Update datetime display
  updateDateTime();
  setInterval(updateDateTime, 60000);
  
  // Calculate form completion
  setupFormValidation();
  
  // Add input listeners for auto-save
  document.querySelectorAll('input, select, textarea').forEach(el => {
    el.addEventListener('change', () => {
      calculateCompletion();
      autoSaveToLocalStorage();
    });
  });
  
  // Initialize circulars list
  loadCirculars();
  
  showToast('Welcome to TaxReply Pro v2.0 with Case Law Database!', 'success');
}

function updateDateTime() {
  const now = new Date();
  const options = { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };
  document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-IN', options);
}

function toggleTheme() {
  const body = document.body;
  const currentTheme = body.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  body.setAttribute('data-theme', newTheme);
  localStorage.setItem('taxreply_theme', newTheme);
  showToast(`Switched to ${newTheme} mode`, 'success');
}

// ============================================
// TAB MANAGEMENT
// ============================================

function switchTab(tabId, clickedTab) {
  // Find parent tab-row
  const tabRow = clickedTab.closest('.card').querySelector('.tab-row');
  const tabContents = clickedTab.closest('.body').querySelectorAll('.tab-content');
  
  // Remove active from all tabs in this row
  tabRow.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  
  // Remove active from all contents
  tabContents.forEach(content => content.classList.remove('active'));
  
  // Add active to clicked tab and corresponding content
  clickedTab.classList.add('active');
  document.getElementById(tabId).classList.add('active');
}

function toggleCollapsible(element) {
  element.classList.toggle('open');
  const content = element.nextElementSibling;
  content.classList.toggle('open');
}

// ============================================
// NOTICE TYPE MANAGEMENT
// ============================================

function populateNoticeTypes() {
  const module = document.getElementById('module').value;
  const select = document.getElementById('noticeType');
  const types = module === 'GST' ? GST_NOTICE_TYPES : IT_NOTICE_TYPES;
  
  select.innerHTML = '';
  types.forEach(type => {
    const option = document.createElement('option');
    option.value = type.id;
    option.textContent = type.name;
    option.dataset.info = JSON.stringify(type);
    select.appendChild(option);
  });
  
  showNoticeInfo();
}

function handleModuleChange() {
  const module = document.getElementById('module').value;
  
  // Update labels
  document.getElementById('idLabel').textContent = module === 'GST' ? 'GSTIN' : 'PAN';
  document.getElementById('yearLabel').textContent = module === 'GST' ? 'Financial Year' : 'Assessment Year';
  
  // Update placeholder
  document.getElementById('idNumber').placeholder = module === 'GST' 
    ? 'e.g., 09AAAAA0000A1Z5' 
    : 'e.g., ABCDE1234F';
  
  // Repopulate notice types
  populateNoticeTypes();
}

function showNoticeInfo() {
  const select = document.getElementById('noticeType');
  const selected = select.options[select.selectedIndex];
  const infoBox = document.getElementById('noticeInfoBox');
  const infoContent = document.getElementById('noticeInfoContent');
  
  if (selected && selected.dataset.info) {
    const info = JSON.parse(selected.dataset.info);
    infoContent.innerHTML = `
      <strong>üìå ${info.name}</strong><br><br>
      <strong>Legal Provision:</strong> ${info.section}<br>
      <strong>Time Limit for Reply:</strong> ${info.timeLimit}<br>
      <strong>Description:</strong> ${info.description}<br>
      ${info.replyFormat ? `<strong>Reply Format:</strong> ${info.replyFormat}` : ''}
    `;
    infoBox.style.display = 'block';
  }
}

function quickSelectNotice() {
  const value = document.getElementById('quickNoticeType').value;
  if (!value) return;
  
  const [module, noticeType] = value.split('|');
  document.getElementById('module').value = module;
  handleModuleChange();
  
  setTimeout(() => {
    document.getElementById('noticeType').value = noticeType;
    showNoticeInfo();
  }, 100);
  
  showToast('Notice type selected. Switch to Notice Details tab for more options.', 'success');
}

// ============================================
// VALIDATION
// ============================================

function validateField(field) {
  if (!field.value.trim()) {
    field.classList.add('error');
    return false;
  }
  field.classList.remove('error');
  return true;
}

function validateGSTIN() {
  const module = document.getElementById('module').value;
  const idNumber = document.getElementById('idNumber').value.toUpperCase();
  const errorDiv = document.getElementById('idError');
  
  if (!idNumber) {
    errorDiv.style.display = 'none';
    return true;
  }
  
  if (module === 'GST') {
    // GSTIN format: 2 digits + 10 char PAN + 1 digit + Z + 1 check digit
    const gstinRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
    if (!gstinRegex.test(idNumber)) {
      errorDiv.textContent = 'Invalid GSTIN format. Expected: 09AAAAA0000A1Z5';
      errorDiv.style.display = 'block';
      document.getElementById('idNumber').classList.add('error');
      return false;
    }
  } else {
    // PAN format: 5 letters + 4 digits + 1 letter
    const panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
    if (!panRegex.test(idNumber)) {
      errorDiv.textContent = 'Invalid PAN format. Expected: ABCDE1234F';
      errorDiv.style.display = 'block';
      document.getElementById('idNumber').classList.add('error');
      return false;
    }
  }
  
  errorDiv.style.display = 'none';
  document.getElementById('idNumber').classList.remove('error');
  return true;
}

function calculateDueDate() {
  const noticeDate = document.getElementById('noticeDate').value;
  const noticeType = document.getElementById('noticeType').value;
  const module = document.getElementById('module').value;
  
  if (!noticeDate) return;
  
  const types = module === 'GST' ? GST_NOTICE_TYPES : IT_NOTICE_TYPES;
  const typeInfo = types.find(t => t.id === noticeType);
  
  if (typeInfo && typeInfo.days) {
    const notice = new Date(noticeDate);
    const due = new Date(notice);
    due.setDate(due.getDate() + typeInfo.days);
    
    document.getElementById('dueDate').value = due.toISOString().split('T')[0];
    
    // Check if due date is approaching
    const today = new Date();
    const daysLeft = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
    
    const warningDiv = document.getElementById('dueDateWarning');
    const warningText = document.getElementById('dueDateText');
    
    if (daysLeft < 0) {
      warningDiv.style.display = 'flex';
      warningDiv.style.borderColor = 'var(--bad)';
      warningDiv.style.background = 'rgba(251,113,133,.15)';
      warningText.textContent = `Due date passed ${Math.abs(daysLeft)} days ago!`;
    } else if (daysLeft <= 3) {
      warningDiv.style.display = 'flex';
      warningDiv.style.borderColor = 'var(--bad)';
      warningText.textContent = `Only ${daysLeft} days left! Urgent action required.`;
    } else if (daysLeft <= 7) {
      warningDiv.style.display = 'flex';
      warningDiv.style.borderColor = 'var(--warn)';
      warningText.textContent = `${daysLeft} days remaining. Prepare reply soon.`;
    } else {
      warningDiv.style.display = 'none';
    }
  }
}

function setupFormValidation() {
  calculateCompletion();
}

function calculateCompletion() {
  const requiredFields = [
    'clientName', 'module', 'idNumber', 'year', 
    'noticeType', 'noticeDate', 'issues', 'facts'
  ];
  
  let filled = 0;
  requiredFields.forEach(id => {
    const el = document.getElementById(id);
    if (el && el.value.trim()) filled++;
  });
  
  const percent = Math.round((filled / requiredFields.length) * 100);
  document.getElementById('completionPercent').textContent = `${percent}%`;
  document.getElementById('completionBar').style.width = `${percent}%`;
}

// ============================================
// ANNEXURE MANAGEMENT
// ============================================

function addAnnexure() {
  const name = document.getElementById('annexureName').value.trim();
  const desc = document.getElementById('annexureDesc').value.trim();
  
  if (!name) {
    showToast('Please enter annexure name', 'warning');
    return;
  }
  
  annexures.push({ name, desc, id: Date.now() });
  renderAnnexures();
  
  document.getElementById('annexureName').value = '';
  document.getElementById('annexureDesc').value = '';
  
  showToast(`Annexure "${name}" added`, 'success');
}

function addQuickAnnexure(name, desc) {
  // Check if already exists
  if (annexures.find(a => a.name === name)) {
    showToast(`"${name}" already added`, 'warning');
    return;
  }
  
  annexures.push({ name, desc, id: Date.now() });
  renderAnnexures();
  showToast(`Annexure "${name}" added`, 'success');
}

function removeAnnexure(id) {
  annexures = annexures.filter(a => a.id !== id);
  renderAnnexures();
}

function renderAnnexures() {
  const container = document.getElementById('annexureList');
  
  if (annexures.length === 0) {
    container.innerHTML = '<span class="small">No annexures added yet</span>';
    return;
  }
  
  container.innerHTML = annexures.map((a, i) => `
    <div class="annexure-item">
      <strong>Annexure ${String.fromCharCode(65 + i)}:</strong> ${a.name}
      ${a.desc ? `<span style="opacity:0.7">(${a.desc})</span>` : ''}
      <button onclick="removeAnnexure(${a.id})" title="Remove">√ó</button>
    </div>
  `).join('');
}

// ============================================
// NOTICE ANALYSIS
// ============================================

function analyseNotice() {
  const fileInput = document.getElementById('noticeFile');
  const textInput = document.getElementById('noticeText').value;
  
  const btn = document.getElementById('analyseBtn');
  btn.classList.add('loading');
  btn.disabled = true;
  
  // Simulate analysis delay
  setTimeout(() => {
    let text = textInput;
    
    // If file uploaded, read it
    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      if (file.type === 'text/plain') {
        const reader = new FileReader();
        reader.onload = function(e) {
          performAnalysis(e.target.result);
        };
        reader.readAsText(file);
        return;
      }
    }
    
    if (!text) {
      showToast('Please upload a file or paste notice text', 'warning');
      btn.classList.remove('loading');
      btn.disabled = false;
      return;
    }
    
    performAnalysis(text);
  }, 500);
}

function performAnalysis(text) {
  const btn = document.getElementById('analyseBtn');
  const resultDiv = document.getElementById('analysisResult');
  
  text = text.toLowerCase();
  let module = 'GST';
  let noticeType = 'MISCELLANEOUS';
  let detectedIssues = [];
  
  // Detect module
  if (text.includes('income tax') || text.includes('section 143') || 
      text.includes('section 148') || text.includes('section 142') ||
      text.includes('assessment year') || text.includes('itr')) {
    module = 'IT';
  }
  
  // Detect GST notice types
  if (module === 'GST') {
    if (text.includes('asmt-10') || text.includes('section 61') || text.includes('scrutiny')) {
      noticeType = 'ASMT-10';
    } else if (text.includes('drc-01') || text.includes('section 73') || text.includes('section 74')) {
      noticeType = 'DRC-01';
    } else if (text.includes('reg-17') || text.includes('cancellation of registration')) {
      noticeType = 'REG-17';
    } else if (text.includes('reg-03') || text.includes('registration') && text.includes('clarification')) {
      noticeType = 'REG-03';
    } else if (text.includes('itc mismatch') || text.includes('2b') || text.includes('input tax credit')) {
      noticeType = 'ITC-MISMATCH';
    } else if (text.includes('mov-07') || text.includes('detention') || text.includes('e-way')) {
      noticeType = 'MOV-07';
    }
    
    // Extract issues
    if (text.includes('itc') || text.includes('input tax credit')) {
      detectedIssues.push('ITC related discrepancy detected');
    }
    if (text.includes('mismatch') || text.includes('difference')) {
      detectedIssues.push('Mismatch/Difference in returns identified');
    }
    if (text.includes('late') || text.includes('delay')) {
      detectedIssues.push('Late filing/payment issue');
    }
  } else {
    // Detect IT notice types
    if (text.includes('143(1)') || text.includes('intimation')) {
      noticeType = '143(1)';
    } else if (text.includes('143(2)') || text.includes('scrutiny')) {
      noticeType = '143(2)';
    } else if (text.includes('148a') || text.includes('148a(b)')) {
      noticeType = '148A(b)';
    } else if (text.includes('148') || text.includes('reassessment')) {
      noticeType = '148';
    } else if (text.includes('142(1)')) {
      noticeType = '142(1)';
    } else if (text.includes('139(9)') || text.includes('defective')) {
      noticeType = '139(9)';
    }
    
    // Extract issues
    if (text.includes('cash deposit') || text.includes('cash')) {
      detectedIssues.push('Cash deposit/transaction issue');
    }
    if (text.includes('mismatch') || text.includes('26as') || text.includes('ais')) {
      detectedIssues.push('Mismatch with 26AS/AIS detected');
    }
  }
  
  // Extract amounts
  const amountMatch = text.match(/rs\.?\s*[\d,]+(?:\.\d{2})?/gi);
  if (amountMatch) {
    detectedIssues.push(`Amount mentioned: ${amountMatch.slice(0, 3).join(', ')}`);
  }
  
  // Enhanced: Detect legal issues and suggest relevant case laws
  let suggestedCaseLaws = [];
  
  if (module === 'GST') {
    if (text.includes('itc') || text.includes('input tax credit')) {
      suggestedCaseLaws.push('Alpine Industries vs. Union of India (ITC eligibility)');
      suggestedCaseLaws.push('M/s. Bharti Airtel Ltd. vs. Union of India (Transitional credit)');
    }
    if (text.includes('interest') || text.includes('section 50')) {
      suggestedCaseLaws.push('TVL. Sify Technologies Ltd. vs. Assistant Commissioner (Interest calculation)');
    }
    if (text.includes('penalty') || text.includes('fraud') || text.includes('suppression')) {
      suggestedCaseLaws.push('M/s. Skill Lotto Solutions vs. Union of India (Penalty provisions)');
    }
    if (text.includes('registration') || text.includes('cancellation')) {
      suggestedCaseLaws.push('M/s. V.S. Reddy & Sons vs. State of Karnataka (Registration cancellation)');
    }
  } else {
    if (text.includes('capital gain') || text.includes('section 45')) {
      suggestedCaseLaws.push('CIT vs. B.C. Srinivasa Setty (Self-generated assets)');
    }
    if (text.includes('unexplained') || text.includes('cash credit') || text.includes('section 68')) {
      suggestedCaseLaws.push('CIT vs. G.R. Karthikeyan (Burden of proof)');
    }
    if (text.includes('penalty') || text.includes('section 271')) {
      suggestedCaseLaws.push('Various ITAT decisions on penalty waiver for bonafide mistakes');
    }
  }
  
  // Update form
  document.getElementById('module').value = module;
  handleModuleChange();
  
  setTimeout(() => {
    document.getElementById('noticeType').value = noticeType;
    showNoticeInfo();
  }, 100);
  
  if (detectedIssues.length > 0) {
    document.getElementById('issues').value = detectedIssues.join('\n');
  }
  
  // Show result
  resultDiv.className = 'status success';
  resultDiv.style.display = 'block';
  
  let resultHTML = `
    <strong>‚úÖ Analysis Complete</strong><br><br>
    <strong>Detected Module:</strong> ${module === 'GST' ? 'GST' : 'Income Tax'}<br>
    <strong>Likely Notice Type:</strong> ${noticeType}<br>
    <strong>Issues Found:</strong> ${detectedIssues.length > 0 ? detectedIssues.join(', ') : 'Please review manually'}<br><br>
  `;
  
  if (suggestedCaseLaws.length > 0) {
    resultHTML += `
      <strong>üìö Suggested Case Law References:</strong><br>
      ${suggestedCaseLaws.map(cl => `‚Ä¢ ${cl}`).join('<br>')}
      <br><br><em>Switch to Case Law Assistant tab for detailed citations and application.</em>
    `;
  }
  
  resultDiv.innerHTML = resultHTML;
  
  btn.classList.remove('loading');
  btn.disabled = false;
  
  calculateCompletion();
  showToast('Notice analysed successfully! Suggested case laws added.', 'success');
}

function clearNoticeImport() {
  document.getElementById('noticeFile').value = '';
  document.getElementById('noticeText').value = '';
  document.getElementById('quickNoticeType').value = '';
  document.getElementById('analysisResult').style.display = 'none';
  showToast('Cleared', 'success');
}

// ============================================
// CASE LAW MANAGEMENT
// ============================================

function searchCaseLaws() {
  const searchTerm = document.getElementById('caseSearchInput').value.toLowerCase();
  const module = document.getElementById('caseLawModule').value;
  const section = document.getElementById('caseLawSection').value.toLowerCase();
  const court = document.getElementById('caseLawCourt').value;
  
  const resultsDiv = document.getElementById('searchResults');
  
  let allCases = [];
  if (module === 'ALL' || module === 'GST') {
    allCases = allCases.concat(GST_CASE_LAWS.map(cl => ({...cl, module: 'GST'})));
  }
  if (module === 'ALL' || module === 'IT') {
    allCases = allCases.concat(IT_CASE_LAWS.map(cl => ({...cl, module: 'IT'})));
  }
  
  // Filter cases
  let filteredCases = allCases.filter(caseLaw => {
    // Text search
    const searchMatch = !searchTerm || 
      caseLaw.title.toLowerCase().includes(searchTerm) ||
      caseLaw.issue.toLowerCase().includes(searchTerm) ||
      caseLaw.summary.toLowerCase().includes(searchTerm) ||
      caseLaw.application.toLowerCase().includes(searchTerm);
    
    // Section filter
    const sectionMatch = !section || 
      caseLaw.section.toLowerCase().includes(section);
    
    // Court filter
    const courtMatch = !court || 
      caseLaw.citation.toLowerCase().includes(court.toLowerCase());
    
    return searchMatch && sectionMatch && courtMatch;
  });
  
  // Display results
  if (filteredCases.length === 0) {
    resultsDiv.innerHTML = `
      <div style="text-align:center; padding:20px; color:var(--muted)">
        No case laws found matching your criteria. Try different keywords.
      </div>
    `;
    return;
  }
  
  resultsDiv.innerHTML = filteredCases.map(caseLaw => `
    <div style="padding:12px; border-bottom:1px solid var(--border);" class="case-law-item" data-id="${caseLaw.id}" data-module="${caseLaw.module}">
      <div style="display:flex; align-items:flex-start; gap:10px;">
        <input type="checkbox" class="case-checkbox" id="case_${caseLaw.id}" 
               onchange="toggleCaseSelection(${caseLaw.id}, '${caseLaw.module}')" />
        <div style="flex:1;">
          <strong>${caseLaw.title}</strong>
          <div style="font-size:11px; color:var(--accent); margin:4px 0">
            ${caseLaw.citation} | ${caseLaw.module} | ${caseLaw.section}
          </div>
          <div style="font-size:12px; margin:6px 0">
            <strong>Issue:</strong> ${caseLaw.issue}
          </div>
          <div style="font-size:11px; color:var(--muted); line-height:1.4">
            ${caseLaw.summary}
          </div>
          <div style="font-size:11px; margin-top:6px; color:var(--accent2)">
            <strong>Application:</strong> ${caseLaw.application}
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

function toggleCaseSelection(id, module) {
  const checkbox = document.querySelector(`#case_${id}`);
  const caseLaw = module === 'GST' 
    ? GST_CASE_LAWS.find(cl => cl.id === id)
    : IT_CASE_LAWS.find(cl => cl.id === id);
  
  if (checkbox.checked) {
    selectedCaseLaws.push({...caseLaw, module});
  } else {
    selectedCaseLaws = selectedCaseLaws.filter(cl => !(cl.id === id && cl.module === module));
  }
  
  updateInsertButton();
}

function updateInsertButton() {
  const btn = document.getElementById('insertCaseBtn');
  const count = selectedCaseLaws.length;
  if (count > 0) {
    btn.innerHTML = `üìù Insert ${count} Selected Case Law${count > 1 ? 's' : ''}`;
    btn.disabled = false;
  } else {
    btn.innerHTML = 'üìù Insert Selected into Legal Grounds';
    btn.disabled = true;
  }
}

function insertSelectedCaseLaws() {
  if (selectedCaseLaws.length === 0) {
    showToast('Please select case laws first', 'warning');
    return;
  }
  
  let legalGroundsText = document.getElementById('legalGrounds').value;
  if (legalGroundsText && !legalGroundsText.endsWith('\n\n')) {
    legalGroundsText += '\n\n';
  }
  
  legalGroundsText += 'Relevant Case Laws:\n\n';
  
  selectedCaseLaws.forEach((caseLaw, index) => {
    legalGroundsText += `${index + 1}. ${caseLaw.title} (${caseLaw.citation})\n`;
    legalGroundsText += `   Section: ${caseLaw.section}\n`;
    legalGroundsText += `   Issue: ${caseLaw.issue}\n`;
    legalGroundsText += `   Held: ${caseLaw.summary}\n\n`;
  });
  
  document.getElementById('legalGrounds').value = legalGroundsText;
  
  showToast(`${selectedCaseLaws.length} case law(s) added to legal grounds`, 'success');
  selectedCaseLaws = [];
  
  // Uncheck all checkboxes
  document.querySelectorAll('.case-checkbox').forEach(cb => {
    cb.checked = false;
  });
  
  updateInsertButton();
}

function browseCaseLaw(module, section) {
  const resultsDiv = document.getElementById('browseResults');
  
  let filteredCases = [];
  if (module === 'GST') {
    filteredCases = GST_CASE_LAWS.filter(cl => 
      cl.section.includes(section) || 
      cl.issue.toLowerCase().includes(section.toLowerCase())
    );
  } else if (module === 'IT') {
    filteredCases = IT_CASE_LAWS.filter(cl => 
      cl.section.includes(section) || 
      cl.issue.toLowerCase().includes(section.toLowerCase())
    );
  } else if (module === 'ALL') {
    filteredCases = [...GST_CASE_LAWS, ...IT_CASE_LAWS].filter(cl => 
      cl.issue.toLowerCase().includes(section.toLowerCase()) ||
      cl.application.toLowerCase().includes(section.toLowerCase()) ||
      cl.summary.toLowerCase().includes(section.toLowerCase())
    );
  }
  
  if (filteredCases.length === 0) {
    resultsDiv.innerHTML = `
      <div style="text-align:center; padding:20px; color:var(--muted)">
        No case laws found for "${section}" in ${module === 'ALL' ? 'both modules' : module}.
      </div>
    `;
    return;
  }
  
  resultsDiv.innerHTML = `
    <div style="margin-bottom:12px; font-size:13px; color:var(--accent)">
      Found ${filteredCases.length} case law(s) for "${section}":
    </div>
    ${filteredCases.map(caseLaw => `
      <div style="padding:10px; margin-bottom:10px; border:1px solid var(--border); border-radius:8px;">
        <strong>${caseLaw.title}</strong>
        <div style="font-size:11px; color:var(--accent2); margin:4px 0">
          ${caseLaw.citation} | ${caseLaw.section}
        </div>
        <div style="font-size:12px; margin:6px 0">
          <strong>Issue:</strong> ${caseLaw.issue}
        </div>
        <div style="font-size:11px; color:var(--muted); line-height:1.4">
          ${caseLaw.summary}
        </div>
        <button class="btn btnGhost" onclick="addSingleCaseLaw(${caseLaw.id}, '${module === 'ALL' ? (caseLaw.module || 'GST') : module}')" 
                style="margin-top:8px; font-size:11px;">
          + Add to Legal Grounds
        </button>
      </div>
    `).join('')}
  `;
}

function addSingleCaseLaw(id, module) {
  const caseLaw = module === 'GST' 
    ? GST_CASE_LAWS.find(cl => cl.id === id)
    : IT_CASE_LAWS.find(cl => cl.id === id);
  
  if (!caseLaw) return;
  
  let legalGroundsText = document.getElementById('legalGrounds').value;
  if (legalGroundsText && !legalGroundsText.endsWith('\n\n')) {
    legalGroundsText += '\n\n';
  }
  
  legalGroundsText += `‚Ä¢ ${caseLaw.title} (${caseLaw.citation}): ${caseLaw.summary}\n`;
  document.getElementById('legalGrounds').value = legalGroundsText;
  
  showToast(`Added "${caseLaw.title}" to legal grounds`, 'success');
}

function clearCaseSearch() {
  document.getElementById('caseSearchInput').value = '';
  document.getElementById('caseLawSection').value = '';
  document.getElementById('caseLawCourt').selectedIndex = 0;
  selectedCaseLaws = [];
  updateInsertButton();
  searchCaseLaws();
}

function loadCirculars() {
  const module = document.getElementById('circularModule').value;
  const circulars = LEGAL_REFERENCES[module];
  const container = document.getElementById('circularsList');
  
  container.innerHTML = circulars.map(circular => `
    <div style="padding:12px; border-bottom:1px solid var(--border);">
      <div style="display:flex; align-items:flex-start; gap:10px;">
        <input type="radio" name="circularSelect" value="${circular.id}" />
        <div style="flex:1;">
          <strong>${circular.type} No. ${circular.number}</strong>
          <div style="font-size:11px; color:var(--accent); margin:4px 0">
            Dated: ${circular.date} | ${circular.subject}
          </div>
          <div style="font-size:12px; margin-top:8px;">
            <strong>Key Points:</strong>
            <ul style="margin:4px 0; padding-left:16px; font-size:11px;">
              ${circular.keyPoints.map(point => `<li>${point}</li>`).join('')}
            </ul>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

function searchCirculars() {
  const searchTerm = document.getElementById('circularSearch').value.toLowerCase();
  const module = document.getElementById('circularModule').value;
  const circulars = LEGAL_REFERENCES[module];
  
  const filteredCirculars = circulars.filter(circular => 
    circular.subject.toLowerCase().includes(searchTerm) ||
    circular.keyPoints.some(point => point.toLowerCase().includes(searchTerm))
  );
  
  const container = document.getElementById('circularsList');
  container.innerHTML = filteredCirculars.map(circular => `
    <div style="padding:12px; border-bottom:1px solid var(--border);">
      <div style="display:flex; align-items:flex-start; gap:10px;">
        <input type="radio" name="circularSelect" value="${circular.id}" />
        <div style="flex:1;">
          <strong>${circular.type} No. ${circular.number}</strong>
          <div style="font-size:11px; color:var(--accent); margin:4px 0">
            Dated: ${circular.date} | ${circular.subject}
          </div>
          <div style="font-size:12px; margin-top:8px;">
            <strong>Key Points:</strong>
            <ul style="margin:4px 0; padding-left:16px; font-size:11px;">
              ${circular.keyPoints.map(point => `<li>${point}</li>`).join('')}
            </ul>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

function insertSelectedCircular() {
  const selected = document.querySelector('input[name="circularSelect"]:checked');
  if (!selected) {
    showToast('Please select a circular first', 'warning');
    return;
  }
  
  const module = document.getElementById('circularModule').value;
  const circular = LEGAL_REFERENCES[module].find(c => c.id === selected.value);
  
  let legalGroundsText = document.getElementById('legalGrounds').value;
  if (legalGroundsText && !legalGroundsText.endsWith('\n\n')) {
    legalGroundsText += '\n\n';
  }
  
  legalGroundsText += `Reference: ${circular.type} No. ${circular.number} dated ${circular.date}\n`;
  legalGroundsText += `Subject: ${circular.subject}\n`;
  legalGroundsText += `Relevant Points: ${circular.keyPoints.join('; ')}\n`;
  
  document.getElementById('legalGrounds').value = legalGroundsText;
  showToast(`Added ${circular.type} ${circular.number} to legal grounds`, 'success');
}

// My Library Functions
function addToMyLibrary() {
  if (selectedCaseLaws.length === 0) {
    showToast('Please select case laws to add to library', 'warning');
    return;
  }
  
  // Add only if not already in library
  selectedCaseLaws.forEach(caseLaw => {
    const exists = myLibrary.some(item => 
      item.id === caseLaw.id && item.module === caseLaw.module
    );
    if (!exists) {
      myLibrary.push(caseLaw);
    }
  });
  
  saveLibrary();
  updateLibraryDisplay();
  showToast(`Added ${selectedCaseLaws.length} item(s) to library`, 'success');
  
  // Clear selection
  selectedCaseLaws = [];
  document.querySelectorAll('.case-checkbox').forEach(cb => {
    cb.checked = false;
  });
  updateInsertButton();
}

function updateLibraryDisplay() {
  const container = document.getElementById('myLibraryList');
  
  if (myLibrary.length === 0) {
    container.innerHTML = `
      <div style="text-align:center; padding:20px; color:var(--muted)">
        Your library is empty. Add case laws from search results.
      </div>
    `;
    return;
  }
  
  container.innerHTML = myLibrary.map((item, index) => `
    <div style="padding:10px; margin-bottom:8px; border:1px solid var(--border); border-radius:8px;">
      <div style="display:flex; justify-content:space-between; align-items:flex-start;">
        <div style="flex:1;">
          <strong>${item.title}</strong>
          <div style="font-size:11px; color:var(--accent); margin:4px 0">
            ${item.citation} | ${item.module} | ${item.section}
          </div>
          <div style="font-size:11px; color:var(--muted); line-height:1.3">
            ${item.issue.substring(0, 100)}...
          </div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn btnGhost" onclick="useFromLibrary(${index})" style="font-size:11px; padding:4px 8px;">
            Use
          </button>
          <button class="btn btnDanger" onclick="removeFromLibrary(${index})" style="font-size:11px; padding:4px 8px;">
            √ó
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

function useFromLibrary(index) {
  const caseLaw = myLibrary[index];
  
  let legalGroundsText = document.getElementById('legalGrounds').value;
  if (legalGroundsText && !legalGroundsText.endsWith('\n\n')) {
    legalGroundsText += '\n\n';
  }
  
  legalGroundsText += `‚Ä¢ ${caseLaw.title} (${caseLaw.citation}): ${caseLaw.summary}\n`;
  document.getElementById('legalGrounds').value = legalGroundsText;
  
  showToast(`Added "${caseLaw.title}" to legal grounds`, 'success');
}

function removeFromLibrary(index) {
  myLibrary.splice(index, 1);
  saveLibrary();
  updateLibraryDisplay();
  showToast('Removed from library', 'success');
}

function clearLibrary() {
  if (myLibrary.length === 0) return;
  
  if (confirm('Are you sure you want to clear your entire case law library?')) {
    myLibrary = [];
    saveLibrary();
    updateLibraryDisplay();
    showToast('Library cleared', 'success');
  }
}

function saveLibrary() {
  localStorage.setItem('taxreply_case_library', JSON.stringify(myLibrary));
}

function loadLibrary() {
  const saved = localStorage.getItem('taxreply_case_library');
  if (saved) {
    myLibrary = JSON.parse(saved);
    updateLibraryDisplay();
  }
}

function exportLibrary() {
  if (myLibrary.length === 0) {
    showToast('Library is empty', 'warning');
    return;
  }
  
  const data = {
    library: myLibrary,
    exportedAt: new Date().toISOString(),
    version: 'TaxReply Pro v2.0'
  };
  
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `TaxReply_Case_Library_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('Library exported successfully', 'success');
}

function importLibrary() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const data = JSON.parse(event.target.result);
        
        if (data.library && Array.isArray(data.library)) {
          // Merge with existing library, avoid duplicates
          data.library.forEach(item => {
            const exists = myLibrary.some(libItem => 
              libItem.id === item.id && libItem.module === item.module
            );
            if (!exists) {
              myLibrary.push(item);
            }
          });
          
          saveLibrary();
          updateLibraryDisplay();
          showToast(`Imported ${data.library.length} item(s) to library`, 'success');
        } else {
          showToast('Invalid library file format', 'error');
        }
      } catch (error) {
        showToast('Error reading library file', 'error');
        console.error(error);
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

// ============================================
// REPLY GENERATION
// ============================================

function generateReply() {
  // Validate required fields
  const clientName = document.getElementById('clientName').value.trim();
  const idNumber = document.getElementById('idNumber').value.trim();
  const issues = document.getElementById('issues').value.trim();
  const facts = document.getElementById('facts').value.trim();
  
  if (!clientName || !idNumber || !issues || !facts) {
    showToast('Please fill all required fields (Client Name, ID, Issues, Facts)', 'warning');
    return;
  }
  
  if (!validateGSTIN()) return;
  
  const btn = document.getElementById('generateBtn');
  btn.classList.add('loading');
  btn.disabled = true;
  
  setTimeout(() => {
    const reply = buildReplyDraft();
    document.getElementById('replyOutput').textContent = reply;
    
    // Update stats
    const module = document.getElementById('module').value;
    stats.total++;
    if (module === 'GST') stats.gst++;
    else stats.it++;
    updateStats();
    
    btn.classList.remove('loading');
    btn.disabled = false;
    
    showToast('Reply generated successfully with case law integration!', 'success');
    autoSaveToLocalStorage();
  }, 800);
}

function buildReplyDraft() {
  const module = document.getElementById('module').value;
  const clientName = document.getElementById('clientName').value.trim();
  const idNumber = document.getElementById('idNumber').value.trim().toUpperCase();
  const year = document.getElementById('year').value.trim();
  const constitution = document.getElementById('constitution').value;
  const businessNature = document.getElementById('businessNature').value.trim();
  
  const noticeType = document.getElementById('noticeType').value;
  const din = document.getElementById('din').value.trim();
  const noticeDate = document.getElementById('noticeDate').value;
  const dueDate = document.getElementById('dueDate').value;
  const officer = document.getElementById('officer').value.trim() || 'The Proper Officer';
  const jurisdiction = document.getElementById('jurisdiction').value.trim();
  const officerAddress = document.getElementById('officerAddress').value.trim();
  
  const issues = document.getElementById('issues').value.trim();
  const facts = document.getElementById('facts').value.trim();
  const disputeAmount = document.getElementById('disputeAmount').value;
  const taxPeriod = document.getElementById('taxPeriod').value.trim();
  const legalGrounds = document.getElementById('legalGrounds').value.trim();
  const prayer = document.getElementById('prayer').value.trim();
  
  // Get notice type info
  const types = module === 'GST' ? GST_NOTICE_TYPES : IT_NOTICE_TYPES;
  const typeInfo = types.find(t => t.id === noticeType) || types[types.length - 1];
  
  const today = new Date().toLocaleDateString('en-IN', {
    day: '2-digit',
    month: 'long',
    year: 'numeric'
  });
  
  const formattedNoticeDate = noticeDate ? new Date(noticeDate).toLocaleDateString('en-IN', {
    day: '2-digit',
    month: 'long',
    year: 'numeric'
  }) : '[Date]';
  
  // Build the reply
  let reply = '';
  
  // Header
  reply += `${'‚ïê'.repeat(70)}
                    REPLY TO ${module === 'GST' ? 'GST' : 'INCOME TAX'} NOTICE
                           ${typeInfo.name}
${'‚ïê'.repeat(70)}

`;

  // Addressee
  reply += `To,
${officer}
${jurisdiction ? jurisdiction + '\n' : ''}${officerAddress ? officerAddress + '\n' : ''}

Date: ${today}

`;

  // Subject
  if (module === 'GST') {
    reply += `Subject: Reply to Notice ${din ? 'bearing DIN: ' + din : ''} dated ${formattedNoticeDate}
         in Form ${noticeType} issued under ${typeInfo.section}
         for ${year}

GSTIN: ${idNumber}
Legal Name: ${clientName}
${constitution ? 'Constitution: ' + constitution : ''}
${taxPeriod ? 'Tax Period: ' + taxPeriod : ''}

`;
  } else {
    reply += `Subject: Reply to Notice ${din ? 'bearing Reference: ' + din : ''} dated ${formattedNoticeDate}
         under ${typeInfo.section} of the Income Tax Act, 1961
         for ${year}

PAN: ${idNumber}
Name of Assessee: ${clientName}
${constitution ? 'Status: ' + constitution : ''}

`;
  }

  // Salutation
  reply += `Respected Sir/Madam,

`;

  // Opening
  reply += `With reference to the above-mentioned notice, I/we, on behalf of the assessee, 
hereby submit this reply for your kind consideration. The submissions made herein 
are without prejudice to the rights of the assessee and subject to verification 
of facts and figures.

${'‚îÄ'.repeat(70)}
                           PRELIMINARY SUBMISSIONS
${'‚îÄ'.repeat(70)}

1. The assessee is engaged in the business of ${businessNature || '[specify business nature]'} 
   and is a ${constitution} duly registered under the applicable laws.

2. The assessee has been complying with all statutory requirements and has been 
   filing returns/statements within the due dates.

3. The assessee has received the above-mentioned notice and hereby submits 
   point-wise reply to the issues raised therein.

`;

  // Point-wise reply
  reply += `${'‚îÄ'.repeat(70)}
                         POINT-WISE REPLY TO ISSUES
${'‚îÄ'.repeat(70)}

ISSUES RAISED IN NOTICE:
${issues}

${'‚îÄ'.repeat(40)}

REPLY AND EXPLANATION:

${facts}

`;

  // Enhanced Legal Grounds and Case Laws Section
  if (legalGrounds) {
    reply += `${'‚îÄ'.repeat(70)}
                     LEGAL SUBMISSIONS & CASE LAWS
${'‚îÄ'.repeat(70)}\n\n`;
    
    // Check if it contains case law references
    const lines = legalGrounds.split('\n').filter(l => l.trim() !== '');
    let inCaseLawSection = false;
    
    lines.forEach(line => {
      if (line.toLowerCase().includes('case law') || 
          line.toLowerCase().includes('citation') ||
          (line.includes('vs.') && (line.includes('SC') || line.includes('HC') || line.includes('ITAT')))) {
        if (!inCaseLawSection) {
          reply += 'RELEVANT JUDICIAL PRECEDENTS:\n\n';
          inCaseLawSection = true;
        }
      }
      
      reply += line + '\n';
    });
    
    if (!inCaseLawSection) {
      reply += 'LEGAL GROUNDS:\n\n' + legalGrounds + '\n\n';
    } else {
      reply += '\n';
    }
  }

  // Dispute amount if any
  if (disputeAmount) {
    reply += `${'‚îÄ'.repeat(70)}
                         AMOUNT IN DISPUTE
${'‚îÄ'.repeat(70)}

Total amount as per notice: Rs. ${parseInt(disputeAmount).toLocaleString('en-IN')}/-

The assessee submits that the above amount has been computed without considering 
the facts and submissions made herein. The correct computation, after considering 
our submissions, would result in [specify outcome].

`;
  }

  // Annexures
  if (annexures.length > 0) {
    reply += `${'‚îÄ'.repeat(70)}
                         LIST OF ANNEXURES
${'‚îÄ'.repeat(70)}

The following documents are enclosed in support of the above submissions:

`;
    annexures.forEach((a, i) => {
      reply += `Annexure-${String.fromCharCode(65 + i)}: ${a.name}${a.desc ? ' (' + a.desc + ')' : ''}\n`;
    });
    reply += '\n';
  }

  // Prayer
  reply += `${'‚îÄ'.repeat(70)}
                              PRAYER
${'‚îÄ'.repeat(70)}

${prayer || `In view of the foregoing facts and circumstances, it is most humbly prayed that 
your Honour may kindly:

a) Consider the submissions made herein and drop the proceedings initiated 
   vide the above-mentioned notice;

b) Grant an opportunity of being heard before passing any adverse order;

c) Pass such other and further orders as may be deemed fit and proper in 
   the interest of justice.`}

`;

  // Closing
  reply += `${'‚îÄ'.repeat(70)}
                           VERIFICATION
${'‚îÄ'.repeat(70)}

I, the undersigned, do hereby verify that the contents of the above reply are 
true and correct to the best of my knowledge and belief, and nothing material 
has been concealed therefrom.

Verified at: [Place]
Date: ${today}

`;

  // Signature block
  reply += `
${'‚îÄ'.repeat(70)}

For ${clientName}
${constitution}


____________________________
Authorised Signatory
Name: 
Designation: 
${module === 'GST' ? 'GSTIN: ' + idNumber : 'PAN: ' + idNumber}

`;

  // Prepared by
  reply += `
${'‚îÄ'.repeat(70)}
Prepared by: [CA Name]
Membership No.: [ICAI Membership Number]
UDIN: [To be generated on signing]
${'‚îÄ'.repeat(70)}

DISCLAIMER: This reply has been prepared based on the information and documents 
provided by the assessee. The accuracy of facts and figures stated herein is the 
responsibility of the assessee. This document is prepared for professional 
assistance and should be verified before submission.

${'‚ïê'.repeat(70)}
                    END OF REPLY DOCUMENT
${'‚ïê'.repeat(70)}
`;

  return reply;
}

// ============================================
// SAMPLE DATA
// ============================================

function loadSampleData() {
  document.getElementById('clientName').value = 'M/s ABC Trading Company';
  document.getElementById('module').value = 'GST';
  handleModuleChange();
  document.getElementById('idNumber').value = '09AABCT1234A1Z5';
  document.getElementById('year').value = 'FY 2023-24';
  document.getElementById('constitution').value = 'Partnership Firm';
  document.getElementById('businessNature').value = 'Trading in Electronic Goods';
  
  setTimeout(() => {
    document.getElementById('noticeType').value = 'ASMT-10';
    showNoticeInfo();
  }, 100);
  
  document.getElementById('din').value = 'GSTN0987654321098';
  document.getElementById('noticeDate').value = '2024-01-15';
  calculateDueDate();
  document.getElementById('officer').value = 'The Proper Officer, State Tax';
  document.getElementById('jurisdiction').value = 'Ward-1, Aligarh Division';
  document.getElementById('officerAddress').value = 'Office of the Deputy Commissioner (ST), GST Bhawan, Aligarh, UP - 202001';
  
  document.getElementById('issues').value = `1. ITC Mismatch: As per GSTR-2B, ITC available is Rs. 5,25,000/- whereas ITC claimed in GSTR-3B is Rs. 5,85,000/-, resulting in excess claim of Rs. 60,000/-

2. Outward Supply Mismatch: Taxable value as per GSTR-1 is Rs. 45,00,000/- but as per GSTR-3B is Rs. 43,50,000/-, difference of Rs. 1,50,000/-

3. Late Fee: Non-filing of GSTR-1 for November 2023 within due date.`;
  
  document.getElementById('facts').value = `1. ITC Difference Explanation:
   - The difference of Rs. 60,000/- is due to invoices from M/s XYZ Suppliers (GSTIN: 09AABCX1234A1Z5) which were reflected in GSTR-2B of January 2024 due to late filing by the supplier.
   - The ITC was legitimately availed based on valid tax invoices and actual receipt of goods.
   - Copies of invoices and goods receipt notes are enclosed as Annexure-A.

2. Outward Supply Difference Explanation:
   - The difference of Rs. 1,50,000/- is on account of credit notes issued during the month for goods returned.
   - Credit notes were duly reported in GSTR-1 but the net effect was shown in GSTR-3B.
   - Reconciliation statement is enclosed as Annexure-B.

3. Late Filing Explanation:
   - The delay in filing GSTR-1 was due to technical issues on the GST portal which was not accessible during the last 2 days of the due date.
   - Screenshot of error message and GSTN advisory are enclosed as Annexure-C.`;
  
  document.getElementById('disputeAmount').value = '60000';
  document.getElementById('taxPeriod').value = 'October 2023 to December 2023';
  
  document.getElementById('legalGrounds').value = `1. As per Section 16(4) of CGST Act, 2017, ITC in respect of any invoice or debit note for supply of goods or services can be availed latest by 30th November following the end of the financial year to which such invoice pertains.

2. Rule 36(4) of CGST Rules provides for restrictions on ITC, however, the same has been relaxed vide Notification No. 94/2020-CT dated 22.12.2020.

3. Reference is made to CBIC Circular No. 183/15/2022-GST dated 27.12.2022 regarding clarification on ITC availment in case of GSTR-2B discrepancies.

4. Reliance is placed on the judgment of Hon'ble Gujarat High Court in the case of Siddharth Enterprises vs. State of Gujarat (2021) wherein it was held that ITC cannot be denied on technical grounds if substantive conditions are fulfilled.`;
  
  document.getElementById('prayer').value = `In view of the above facts, submissions and documentary evidence, it is most respectfully prayed that:

a) The proceeding initiated vide the impugned notice may kindly be dropped as the alleged discrepancies stand explained;

b) Alternatively, an opportunity of personal hearing may be granted before passing any adverse order;

c) The demand, if any, may be computed correctly after considering our submissions;

d) Any penalty proceedings may not be initiated as there is no willful suppression or fraud on part of the assessee.`;
  
  // Add sample annexures
  annexures = [
    { name: 'Tax Invoices & GRN', desc: 'From M/s XYZ Suppliers', id: 1 },
    { name: 'Reconciliation Statement', desc: 'GSTR-1 vs GSTR-3B', id: 2 },
    { name: 'Portal Error Screenshots', desc: 'GST Portal Issues', id: 3 },
    { name: 'GSTR-3B Copies', desc: 'Oct-Dec 2023', id: 4 }
  ];
  renderAnnexures();
  
  // Add sample case laws to library for demonstration
  myLibrary = [
    GST_CASE_LAWS[0],
    GST_CASE_LAWS[1],
    IT_CASE_LAWS[0]
  ];
  updateLibraryDisplay();
  
  calculateCompletion();
  showToast('Sample data loaded successfully with case laws!', 'success');
}

function resetForm() {
  if (!confirm('Are you sure you want to reset all fields?')) return;
  
  document.querySelectorAll('input, textarea, select').forEach(el => {
    if (el.type === 'date') {
      el.value = new Date().toISOString().split('T')[0];
    } else if (el.tagName === 'SELECT') {
      el.selectedIndex = 0;
    } else {
      el.value = '';
    }
    el.classList.remove('error');
  });
  
  annexures = [];
  renderAnnexures();
  
  document.getElementById('replyOutput').textContent = '(Your professionally drafted reply will appear here after generation...)';
  document.getElementById('analysisResult').style.display = 'none';
  
  handleModuleChange();
  calculateCompletion();
  
  showToast('Form reset successfully', 'success');
}

// ============================================
// EXPORT FUNCTIONS
// ============================================

function copyToClipboard() {
  const text = document.getElementById('replyOutput').textContent;
  navigator.clipboard.writeText(text).then(() => {
    showToast('Copied to clipboard!', 'success');
  }).catch(() => {
    showToast('Failed to copy', 'error');
  });
}

function downloadTXT() {
  const text = document.getElementById('replyOutput').textContent;
  const clientName = document.getElementById('clientName').value || 'Reply';
  downloadFile(text, `${clientName.replace(/[^a-zA-Z0-9]/g, '_')}_Reply.txt`, 'text/plain');
}

function downloadJSON() {
  const data = collectFormData();
  const json = JSON.stringify(data, null, 2);
  const clientName = document.getElementById('clientName').value || 'Reply';
  downloadFile(json, `${clientName.replace(/[^a-zA-Z0-9]/g, '_')}_Data.json`, 'application/json');
}

function downloadHTML() {
  const text = document.getElementById('replyOutput').textContent;
  const clientName = document.getElementById('clientName').value || 'Reply';
  const module = document.getElementById('module').value;
  
  const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${module} Notice Reply - ${clientName}</title>
  <style>
    body { font-family: 'Courier New', monospace; padding: 40px; max-width: 800px; margin: auto; line-height: 1.6; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    @media print { body { padding: 20px; } }
  </style>
</head>
<body>
<pre>${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
</body>
</html>`;
  
  downloadFile(html, `${clientName.replace(/[^a-zA-Z0-9]/g, '_')}_Reply.html`, 'text/html');
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast(`Downloaded: ${filename}`, 'success');
}

function printPDF() {
  const content = document.getElementById('replyOutput').textContent;
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>GST/IT Notice Reply</title>
      <style>
        body { 
          font-family: 'Courier New', Courier, monospace; 
          padding: 40px; 
          line-height: 1.6;
          font-size: 12px;
        }
        pre { 
          white-space: pre-wrap; 
          word-wrap: break-word;
          margin: 0;
        }
        @page { 
          margin: 2cm; 
        }
      </style>
    </head>
    <body>
      <pre>${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => printWindow.print(), 500);
}

// ============================================
// LOCAL STORAGE
// ============================================

function collectFormData() {
  return {
    clientName: document.getElementById('clientName').value,
    module: document.getElementById('module').value,
    idNumber: document.getElementById('idNumber').value,
    year: document.getElementById('year').value,
    constitution: document.getElementById('constitution').value,
    businessNature: document.getElementById('businessNature').value,
    noticeType: document.getElementById('noticeType').value,
    din: document.getElementById('din').value,
    noticeDate: document.getElementById('noticeDate').value,
    dueDate: document.getElementById('dueDate').value,
    officer: document.getElementById('officer').value,
    jurisdiction: document.getElementById('jurisdiction').value,
    officerAddress: document.getElementById('officerAddress').value,
    issues: document.getElementById('issues').value,
    facts: document.getElementById('facts').value,
    disputeAmount: document.getElementById('disputeAmount').value,
    taxPeriod: document.getElementById('taxPeriod').value,
    legalGrounds: document.getElementById('legalGrounds').value,
    prayer: document.getElementById('prayer').value,
    annexures: annexures,
    generatedReply: document.getElementById('replyOutput').textContent,
    savedAt: new Date().toISOString()
  };
}

function autoSaveToLocalStorage() {
  const data = collectFormData();
  localStorage.setItem('taxreply_current', JSON.stringify(data));
}

function loadFromLocalStorage() {
  // Load current data
  const current = localStorage.getItem('taxreply_current');
  if (current) {
    try {
      const data = JSON.parse(current);
      restoreFormData(data);
    } catch (e) {
      console.log('No saved data to restore');
    }
  }
  
  // Load saved drafts
  const drafts = localStorage.getItem('taxreply_drafts');
  if (drafts) {
    savedDrafts = JSON.parse(drafts);
    document.getElementById('savedDraftsCount').innerHTML = `Saved: <strong>${savedDrafts.length}</strong> Drafts`;
  }
  
  // Load stats
  const savedStats = localStorage.getItem('taxreply_stats');
  if (savedStats) {
    stats = JSON.parse(savedStats);
    updateStats();
  }
}

function restoreFormData(data) {
  Object.keys(data).forEach(key => {
    const el = document.getElementById(key);
    if (el && data[key] && key !== 'annexures' && key !== 'generatedReply' && key !== 'savedAt') {
      el.value = data[key];
    }
  });
  
  if (data.annexures) {
    annexures = data.annexures;
    renderAnnexures();
  }
  
  if (data.generatedReply && data.generatedReply !== '(Your professionally drafted reply will appear here after generation...)') {
    document.getElementById('replyOutput').textContent = data.generatedReply;
  }
  
  handleModuleChange();
  calculateCompletion();
}

function saveAsDraft() {
  const clientName = document.getElementById('clientName').value.trim();
  if (!clientName) {
    showToast('Please enter client name before saving', 'warning');
    return;
  }
  
  const data = collectFormData();
  data.id = Date.now();
  data.name = `${clientName} - ${document.getElementById('module').value} - ${new Date().toLocaleDateString('en-IN')}`;
  
  savedDrafts.push(data);
  localStorage.setItem('taxreply_drafts', JSON.stringify(savedDrafts));
  document.getElementById('savedDraftsCount').innerHTML = `Saved: <strong>${savedDrafts.length}</strong> Drafts`;
  
  showToast('Draft saved successfully!', 'success');
}

function loadSavedDrafts() {
  const modal = document.getElementById('draftsModal');
  const content = document.getElementById('draftsModalContent');
  
  if (savedDrafts.length === 0) {
    content.innerHTML = '<p style="text-align:center; color:var(--muted)">No saved drafts found</p>';
  } else {
    content.innerHTML = savedDrafts.map(draft => `
      <div style="padding:12px; border:1px solid var(--border); border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong>${draft.name}</strong><br>
          <small style="color:var(--muted)">Saved: ${new Date(draft.savedAt).toLocaleString('en-IN')}</small>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn btnGhost" onclick="loadDraft(${draft.id})">üìÇ Load</button>
          <button class="btn btnDanger" onclick="deleteDraft(${draft.id})">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
  }
  
  modal.style.display = 'block';
}

function closeDraftsModal() {
  document.getElementById('draftsModal').style.display = 'none';
}

function loadDraft(id) {
  const draft = savedDrafts.find(d => d.id === id);
  if (draft) {
    restoreFormData(draft);
    closeDraftsModal();
    showToast('Draft loaded successfully!', 'success');
  }
}

function deleteDraft(id) {
  if (!confirm('Delete this draft?')) return;
  savedDrafts = savedDrafts.filter(d => d.id !== id);
  localStorage.setItem('taxreply_drafts', JSON.stringify(savedDrafts));
  loadSavedDrafts();
  document.getElementById('savedDraftsCount').innerHTML = `Saved: <strong>${savedDrafts.length}</strong> Drafts`;
  showToast('Draft deleted', 'success');
}

function updateStats() {
  document.getElementById('totalReplies').textContent = stats.total;
  document.getElementById('gstReplies').textContent = stats.gst;
  document.getElementById('itReplies').textContent = stats.it;
  document.getElementById('pendingReplies').textContent = stats.pending;
  localStorage.setItem('taxreply_stats', JSON.stringify(stats));
}

// ============================================
// DOCUMENT GENERATION (Other Documents)
// ============================================

function generateAuthorization() {
  const authType = document.getElementById('authType').value;
  const authorizerName = document.getElementById('authorizerName').value.trim() || '[Authorizing Person Name]';
  const authorizedName = document.getElementById('authorizedName').value.trim() || '[Authorized Person Name]';
  const membershipNo = document.getElementById('membershipNo').value.trim();
  const scope = document.getElementById('authScope').value.trim();
  const clientName = document.getElementById('clientName').value.trim() || '[Entity Name]';
  const idNumber = document.getElementById('idNumber').value.trim() || '[GSTIN/PAN]';
  
  const today = new Date().toLocaleDateString('en-IN', {
    day: '2-digit', month: 'long', year: 'numeric'
  });
  
  let doc = '';
  
  if (authType === 'GST_AUTH') {
    doc = `
${'‚ïê'.repeat(60)}
              AUTHORIZATION LETTER
          (For Representation under GST)
${'‚ïê'.repeat(60)}

Date: ${today}

To,
The Proper Officer
[Jurisdiction]

Subject: Authorization for representation in GST proceedings

GSTIN: ${idNumber}
Legal Name: ${clientName}

Dear Sir/Madam,

I/We, ${authorizerName}, hereby authorize ${authorizedName}
${membershipNo ? '(ICAI Membership No.: ' + membershipNo + ')' : ''}
to represent me/us before the GST authorities and to:

${scope || `1. Appear and represent in all GST related proceedings
2. Sign and submit replies to notices
3. Attend personal hearings
4. Access and operate GST Portal on our behalf
5. Submit applications, returns, and refund claims
6. Collect documents and orders`}

This authorization is valid until revoked in writing.

For ${clientName}


____________________________
${authorizerName}
Authorised Signatory
Date: ${today}
Place: [Place]

${'‚ïê'.repeat(60)}
`;
  } else if (authType === 'IT_AUTH') {
    doc = `
${'‚ïê'.repeat(60)}
            AUTHORIZATION LETTER
      (Authorized Representative - Income Tax)
${'‚ïê'.repeat(60)}

Date: ${today}

To,
The Assessing Officer
[Ward/Circle]
Income Tax Department

Subject: Appointment of Authorized Representative u/s 288

PAN: ${idNumber}
Name of Assessee: ${clientName}

Sir/Madam,

I/We hereby appoint ${authorizedName}
${membershipNo ? ', Chartered Accountant (M.No.: ' + membershipNo + ')' : ''}
as my/our Authorized Representative to appear before the Income Tax 
authorities and represent in all matters related to my/our income tax 
assessments/proceedings.

The scope of representation includes:
${scope || `- Attending assessments, appeals and other proceedings
- Signing and filing returns, statements and applications
- Making submissions and providing information
- Receiving communications and notices
- All other acts necessary for the proceedings`}

This authorization shall remain valid until revoked in writing.

Yours faithfully,


____________________________
${authorizerName}
${clientName}
PAN: ${idNumber}

${'‚ïê'.repeat(60)}
`;
  }
  
  document.getElementById('docOutput').textContent = doc;
  showToast('Authorization letter generated!', 'success');
}

function generateUndertaking() {
  const type = document.getElementById('undertakingType').value;
  const ref = document.getElementById('undertakingRef').value.trim() || '[Reference Number/Date]';
  const content = document.getElementById('undertakingContent').value.trim();
  const clientName = document.getElementById('clientName').value.trim() || '[Entity Name]';
  const idNumber = document.getElementById('idNumber').value.trim() || '[GSTIN/PAN]';
  const module = document.getElementById('module').value;
  
  const today = new Date().toLocaleDateString('en-IN', {
    day: '2-digit', month: 'long', year: 'numeric'
  });
  
  let doc = '';
  let title = '';
  let undertakingText = '';
  
  switch(type) {
    case 'NO_PENALTY':
      title = 'UNDERTAKING FOR WAIVER OF PENALTY';
      undertakingText = content || `I/We hereby undertake and confirm that:

1. The non-compliance/discrepancy pointed out in the notice was not intentional 
   and occurred due to bonafide mistake/inadvertent error.

2. There was no intention to evade tax or claim undue benefit.

3. I/We have now rectified the error and paid the applicable tax along with interest.

4. I/We shall ensure compliance with all statutory provisions in future.

5. No fraud, willful misstatement or suppression of facts has been committed.

In view of the above, it is requested to kindly waive the penalty as the 
default was not willful and has been rectified.`;
      break;
      
    case 'GENUINE_TXN':
      title = 'UNDERTAKING FOR GENUINENESS OF TRANSACTIONS';
      undertakingText = content || `I/We hereby solemnly affirm and undertake that:

1. All transactions reflected in my/our returns are genuine and backed by 
   valid tax invoices/documents.

2. The goods/services have actually been received/supplied as claimed.

3. Payments have been made/received through banking channels.

4. I/We have verified the GSTIN/PAN of all parties and they are genuine taxpayers.

5. I/We have maintained proper books of accounts and records as required by law.

6. I/We shall produce all documentary evidence if required by the department.

7. In case any transaction is found to be non-genuine, I/we shall be liable 
   for all consequences as per law.`;
      break;
      
    case 'BOOKS_DESTROYED':
      title = 'UNDERTAKING REGARDING LOSS/DESTRUCTION OF BOOKS';
      undertakingText = content || `I/We hereby declare and undertake that:

1. The books of accounts and records for the period [specify period] have been 
   destroyed/damaged/lost due to [fire/flood/theft/natural calamity].

2. The loss occurred on [date] and FIR/Insurance Claim has been lodged 
   (Copy enclosed).

3. I/We have made sincere efforts to reconstruct the records from available 
   sources such as bank statements, counterparty confirmations, etc.

4. The reconstructed records/best estimate of transactions is enclosed herewith.

5. I/We undertake to provide any additional information that may be available 
   or can be obtained from third parties.

6. This undertaking is given in good faith and to the best of my/our knowledge.`;
      break;
      
    case 'BONAFIDE':
      title = 'UNDERTAKING FOR BONAFIDE MISTAKE';
      undertakingText = content || `I/We hereby declare and undertake that:

1. The error/discrepancy pointed out was a bonafide mistake committed 
   inadvertently without any malafide intention.

2. I/We had no intention to evade tax or cause any loss to the exchequer.

3. The mistake occurred due to [oversight/clerical error/system error/
   misunderstanding of provisions].

4. Immediately upon discovery, steps were taken to rectify the same.

5. I/We have now corrected the error and complied with the provisions.

6. I/We shall exercise due diligence to prevent such errors in future.

7. I/We request that the said mistake may be condoned as a bonafide error.`;
      break;
      
    case 'ITC_REVERSAL':
      title = 'UNDERTAKING FOR ITC REVERSAL';
      undertakingText = content || `I/We hereby declare and undertake that:

1. I/We have identified the excess/ineligible ITC claimed as pointed out in 
   the notice.

2. The ITC of Rs. [Amount] has been reversed in GSTR-3B for the month of 
   [Month/Year].

3. Interest on the delayed payment, if applicable, has been computed and paid.

4. I/We undertake not to re-avail this ITC in future unless eligible.

5. The reversal has been made in Table 4(B) of GSTR-3B as per Rule 42/43.

6. I/We have maintained proper records of such reversal for verification.

7. A copy of the relevant GSTR-3B showing reversal is enclosed herewith.`;
      break;
  }
  
  doc = `
${'‚ïê'.repeat(65)}
                         ${title}
${'‚ïê'.repeat(65)}

Reference: ${ref}
Date: ${today}

To,
The Proper Officer / Assessing Officer
[Jurisdiction/Ward]

${module === 'GST' ? 'GSTIN: ' + idNumber : 'PAN: ' + idNumber}
Name: ${clientName}

${'‚îÄ'.repeat(65)}
                         UNDERTAKING
${'‚îÄ'.repeat(65)}

${undertakingText}

${'‚îÄ'.repeat(65)}
                         VERIFICATION
${'‚îÄ'.repeat(65)}

I/We, the undersigned, do hereby solemnly affirm and declare that the 
contents of the above undertaking are true and correct to the best of 
my/our knowledge and belief. I/We understand that any false statement 
made herein shall render me/us liable for legal action as per applicable 
laws.

Verified at: [Place]
Date: ${today}


${'‚îÄ'.repeat(65)}

For ${clientName}


____________________________
Authorised Signatory
Name: 
Designation:
${module === 'GST' ? 'GSTIN: ' + idNumber : 'PAN: ' + idNumber}


Witnesses (if required):

1. Name: _________________ Signature: _________________
   Address: ___________________________________________

2. Name: _________________ Signature: _________________
   Address: ___________________________________________

${'‚ïê'.repeat(65)}
`;

  document.getElementById('docOutput').textContent = doc;
  showToast('Undertaking generated!', 'success');
}

function generatePartnershipDeed() {
  const docType = document.getElementById('partnershipDocType').value;
  const firmName = document.getElementById('firmName').value.trim() || '[FIRM NAME]';
  const firmAddress = document.getElementById('firmAddress').value.trim() || '[Complete Address]';
  const firmBusiness = document.getElementById('firmBusiness').value.trim() || '[Nature of Business]';
  const partnersRaw = document.getElementById('partnersDetails').value.trim();
  
  const today = new Date().toLocaleDateString('en-IN', {
    day: '2-digit', month: 'long', year: 'numeric'
  });
  
  // Parse partners
  let partners = [];
  if (partnersRaw) {
    const lines = partnersRaw.split('\n');
    lines.forEach((line, idx) => {
      const parts = line.split('|').map(p => p.trim());
      if (parts[0]) {
        partners.push({
          name: parts[0] || `Partner ${idx + 1}`,
          fatherName: parts[1] || '[Father\'s Name]',
          address: parts[2] || '[Address]',
          pan: parts[3] || '[PAN]',
          share: parts[4] || '50',
          capital: parts[5] || '0'
        });
      }
    });
  }
  
  if (partners.length < 2) {
    partners = [
      { name: 'Partner 1', fatherName: '[Father\'s Name]', address: '[Address]', pan: '[PAN]', share: '50', capital: '500000' },
      { name: 'Partner 2', fatherName: '[Father\'s Name]', address: '[Address]', pan: '[PAN]', share: '50', capital: '500000' }
    ];
  }
  
  let doc = '';
  
  if (docType === 'DEED') {
    doc = `
${'‚ïê'.repeat(70)}
                        PARTNERSHIP DEED
${'‚ïê'.repeat(70)}

This Partnership Deed is made and executed at [Place] on this ${today}

                             BETWEEN

${partners.map((p, i) => `${i + 1}. ${p.name}, S/o ${p.fatherName},
   R/o ${p.address}
   PAN: ${p.pan}
   (Hereinafter referred to as "Partner ${i + 1}" or "${p.name.split(' ')[0]}")`).join('\n\n')}

(The above parties are hereinafter collectively referred to as "Partners" 
and individually as "Partner")

${'‚îÄ'.repeat(70)}
                           WHEREAS
${'‚îÄ'.repeat(70)}

The Partners have agreed to carry on business in partnership under the 
name and style of "${firmName}" and have agreed to reduce the terms 
and conditions of their partnership into writing.

NOW THIS DEED WITNESSETH AND IT IS HEREBY AGREED BY AND BETWEEN THE 
PARTIES HERETO AS FOLLOWS:

${'‚îÄ'.repeat(70)}
                    TERMS AND CONDITIONS
${'‚îÄ'.repeat(70)}

1. NAME OF THE FIRM
   The Partnership Firm shall be known as "${firmName}"

2. PRINCIPAL PLACE OF BUSINESS
   ${firmAddress}

3. NATURE OF BUSINESS
   The partnership shall carry on the business of ${firmBusiness} and 
   any other business as may be mutually agreed upon by all partners.

4. COMMENCEMENT DATE
   The partnership shall be deemed to have commenced from ${today} and 
   shall continue unless dissolved by mutual consent or operation of law.

5. CAPITAL CONTRIBUTION
   The partners shall contribute capital as under:

   ${partners.map((p, i) => `Partner ${i + 1} (${p.name}): Rs. ${parseInt(p.capital).toLocaleString('en-IN')}/-`).join('\n   ')}

   Total Capital: Rs. ${partners.reduce((sum, p) => sum + parseInt(p.capital), 0).toLocaleString('en-IN')}/-

6. PROFIT AND LOSS SHARING RATIO
   The profits and losses of the firm shall be shared among the partners 
   in the following ratio:

   ${partners.map((p, i) => `Partner ${i + 1} (${p.name}): ${p.share}%`).join('\n   ')}

7. INTEREST ON CAPITAL
   Interest on capital shall be allowed @ 12% per annum to all partners.

8. DRAWINGS
   Partners may draw a sum not exceeding Rs. [Amount] per month for 
   personal expenses. Interest @ 12% p.a. shall be charged on drawings.

9. PARTNER'S SALARY/REMUNERATION
   The working partners shall be entitled to salary/remuneration as per 
   Section 40(b) of the Income Tax Act, 1961 or as mutually agreed.

10. DUTIES OF PARTNERS
    a) All partners shall be just and faithful to each other.
    b) All partners shall devote their full time and attention to the 
       business of the firm.
    c) Proper books of accounts shall be maintained at the principal 
       place of business.
    d) Each partner shall render true accounts of all dealings.

11. BANKING
    The bank account of the firm shall be opened/maintained with 
    [Bank Name] and shall be operated by [Partner Name(s)].

12. RETIREMENT/ADMISSION
    a) Any partner may retire by giving 3 months' notice in writing.
    b) New partner may be admitted only with consent of all partners.
    c) On retirement/admission, goodwill shall be valued at [Method].

13. DEATH/INSOLVENCY
    In case of death or insolvency of any partner, the firm shall not 
    dissolve but the legal heirs/representative shall be entitled to 
    the deceased/insolvent partner's share as per books.

14. DISSOLUTION
    The firm may be dissolved by mutual consent of all partners or as 
    per provisions of the Indian Partnership Act, 1932.

15. DISPUTES
    Any dispute arising between the partners shall be referred to 
    arbitration under the Arbitration and Conciliation Act, 1996.

16. MISCELLANEOUS
    a) This deed shall be governed by Indian Partnership Act, 1932.
    b) Any modification shall be in writing and signed by all partners.
    c) The partners shall register this deed under the Partnership Act.

${'‚îÄ'.repeat(70)}
                    IN WITNESS WHEREOF
${'‚îÄ'.repeat(70)}

The parties hereto have signed this Deed on the day, month and year 
first above written.

PARTNERS:

${partners.map((p, i) => `
${i + 1}. ${p.name}
   
   Signature: ____________________
   
   PAN: ${p.pan}`).join('\n')}


WITNESSES:

1. Name: _________________________
   Address: ______________________
   Signature: ____________________

2. Name: _________________________
   Address: ______________________
   Signature: ____________________

${'‚ïê'.repeat(70)}
           SCHEDULE OF CAPITAL CONTRIBUTIONS
${'‚ïê'.repeat(70)}

Partner Name            |    Capital (Rs.)    |   Share (%)
${'-'.repeat(70)}
${partners.map(p => `${p.name.padEnd(23)} |    ${parseInt(p.capital).toLocaleString('en-IN').padStart(15)} |     ${p.share}%`).join('\n')}
${'-'.repeat(70)}
${'TOTAL'.padEnd(23)} |    ${partners.reduce((sum, p) => sum + parseInt(p.capital), 0).toLocaleString('en-IN').padStart(15)} |    100%

${'‚ïê'.repeat(70)}
`;
  } else if (docType === 'AMENDMENT') {
    doc = `
${'‚ïê'.repeat(70)}
              AMENDMENT TO PARTNERSHIP DEED
${'‚ïê'.repeat(70)}

This Amendment Deed is made and executed at [Place] on this ${today}

BETWEEN the Partners of M/s ${firmName}

${'‚îÄ'.repeat(70)}
                           WHEREAS
${'‚îÄ'.repeat(70)}

1. The Partners executed a Partnership Deed dated [Original Deed Date] 
   for carrying on business in partnership.

2. The Partners have mutually agreed to amend certain clauses of the 
   said Partnership Deed.

NOW THIS DEED WITNESSETH AS FOLLOWS:

${'‚îÄ'.repeat(70)}
                    AMENDMENTS AGREED
${'‚îÄ'.repeat(70)}

1. Clause No. [X] of the original deed is hereby amended as follows:
   [Old Provision] is replaced with [New Provision]

2. [Add more amendments as needed]

3. All other terms and conditions of the original Partnership Deed 
   shall remain unchanged and in full force and effect.

4. This Amendment shall be effective from ${today}.

${'‚îÄ'.repeat(70)}
                    IN WITNESS WHEREOF
${'‚îÄ'.repeat(70)}

The Partners have signed this Amendment Deed on the day and year first 
above written.

PARTNERS:
${partners.map((p, i) => `
${i + 1}. ${p.name}
   Signature: ____________________`).join('\n')}

WITNESSES:
1. ____________________  2. ____________________

${'‚ïê'.repeat(70)}
`;
  } else if (docType === 'ADMISSION') {
    doc = `
${'‚ïê'.repeat(70)}
            DEED OF ADMISSION OF PARTNER
${'‚ïê'.repeat(70)}

This Deed of Admission is made at [Place] on this ${today}

BETWEEN the existing Partners of M/s ${firmName} AND
[New Partner Name], S/o [Father's Name], R/o [Address]

${'‚îÄ'.repeat(70)}
                           RECITALS
${'‚îÄ'.repeat(70)}

1. M/s ${firmName} is a partnership firm carrying on business of 
   ${firmBusiness}.

2. The existing partners have agreed to admit [New Partner Name] as a 
   new partner in the firm.

3. All parties have agreed to the terms of admission as set out herein.

${'‚îÄ'.repeat(70)}
                    TERMS OF ADMISSION
${'‚îÄ'.repeat(70)}

1. [New Partner Name] is admitted as partner w.e.f. ${today}.

2. Capital Contribution: Rs. [Amount]/-

3. Profit/Loss Sharing Ratio (Revised):
   [List revised ratios for all partners]

4. Goodwill: [Terms of goodwill payment/waiver]

5. All rights and obligations as per the Partnership Deed shall apply 
   to the new partner.

${'‚îÄ'.repeat(70)}
                    IN WITNESS WHEREOF
${'‚îÄ'.repeat(70)}

EXISTING PARTNERS:                    NEW PARTNER:

1. __________________                 __________________
                                      [New Partner Name]
2. __________________

WITNESSES:
1. __________________  2. __________________

${'‚ïê'.repeat(70)}
`;
  } else if (docType === 'RETIREMENT') {
    doc = `
${'‚ïê'.repeat(70)}
            DEED OF RETIREMENT OF PARTNER
${'‚ïê'.repeat(70)}

This Deed of Retirement is made at [Place] on this ${today}

BETWEEN the Partners of M/s ${firmName}

${'‚îÄ'.repeat(70)}
                           RECITALS
${'‚îÄ'.repeat(70)}

1. M/s ${firmName} is a partnership firm constituted vide deed dated 
   [Original Deed Date].

2. [Retiring Partner Name] desires to retire from the partnership.

3. The continuing partners have agreed to the retirement and settlement 
   terms as set out herein.

${'‚îÄ'.repeat(70)}
                  TERMS OF RETIREMENT
${'‚îÄ'.repeat(70)}

1. [Retiring Partner Name] shall cease to be a partner w.e.f. ${today}.

2. Settlement Amount: The retiring partner shall be paid:
   a) Capital Balance: Rs. [Amount]/-
   b) Share of Goodwill: Rs. [Amount]/-
   c) Share of Profits till retirement: Rs. [Amount]/-
   
   Total: Rs. [Amount]/-

3. Payment Terms: [Lump sum / Installments]

4. The retiring partner shall not carry on competing business for a 
   period of [X] years within [geographical area].

5. The continuing partners shall discharge all liabilities of the firm.

6. The firm shall continue under the same name by the continuing partners.

${'‚îÄ'.repeat(70)}
                    IN WITNESS WHEREOF
${'‚îÄ'.repeat(70)}

RETIRING PARTNER:                     CONTINUING PARTNERS:

__________________                    1. __________________
[Retiring Partner]
                                      2. __________________

WITNESSES:
1. __________________  2. __________________

${'‚ïê'.repeat(70)}
`;
  } else if (docType === 'DISSOLUTION') {
    doc = `
${'‚ïê'.repeat(70)}
            DEED OF DISSOLUTION OF PARTNERSHIP
${'‚ïê'.repeat(70)}

This Deed of Dissolution is made at [Place] on this ${today}

BETWEEN the Partners of M/s ${firmName}

${'‚îÄ'.repeat(70)}
                           RECITALS
${'‚îÄ'.repeat(70)}

1. The partners have been carrying on partnership business under the 
   name of M/s ${firmName}.

2. The partners have mutually agreed to dissolve the partnership firm.

${'‚îÄ'.repeat(70)}
                  TERMS OF DISSOLUTION
${'‚îÄ'.repeat(70)}

1. The partnership firm M/s ${firmName} stands dissolved with effect 
   from ${today}.

2. Settlement of Assets and Liabilities:
   a) All assets shall be realized at market value
   b) All liabilities shall be discharged from the proceeds
   c) Balance shall be distributed as per profit sharing ratio

3. Books of Accounts: All books and records shall be maintained for 
   the statutory period and shall be in custody of [Partner Name].

4. Pending Matters: [Partner Name] is authorized to complete all 
   pending transactions and settlement.

5. Indemnity: Each partner indemnifies the other against any claims 
   arising from their actions.

6. GST Registration: Shall be cancelled as per provisions of GST law.

7. Bank Accounts: Shall be closed after final settlement.

${'‚îÄ'.repeat(70)}
                    IN WITNESS WHEREOF
${'‚îÄ'.repeat(70)}

PARTNERS:
${partners.map((p, i) => `
${i + 1}. ${p.name}
   Signature: ____________________`).join('\n')}

WITNESSES:
1. __________________  2. __________________

${'‚ïê'.repeat(70)}
        FINAL SETTLEMENT ACCOUNT (To be prepared)
${'‚ïê'.repeat(70)}
`;
  }
  
  document.getElementById('docOutput').textContent = doc;
  showToast('Partnership document generated!', 'success');
}

function generateMiscDoc() {
  const docType = document.getElementById('miscDocType').value;
  const ref = document.getElementById('miscRef').value.trim() || '[Reference]';
  const reason = document.getElementById('miscReason').value.trim();
  const clientName = document.getElementById('clientName').value.trim() || '[Entity Name]';
  const idNumber = document.getElementById('idNumber').value.trim() || '[GSTIN/PAN]';
  const module = document.getElementById('module').value;
  
  const today = new Date().toLocaleDateString('en-IN', {
    day: '2-digit', month: 'long', year: 'numeric'
  });
  
  let doc = '';
  
  switch(docType) {
    case 'COVER_LETTER':
      doc = `
${'‚ïê'.repeat(60)}
                     COVER LETTER
${'‚ïê'.repeat(60)}

Date: ${today}

To,
The Proper Officer / Assessing Officer
[Jurisdiction/Ward]
[Address]

Subject: Submission of Documents/Reply vide ${ref}

${module === 'GST' ? 'GSTIN' : 'PAN'}: ${idNumber}
Name: ${clientName}

Respected Sir/Madam,

${reason || `With reference to the above, I/we hereby submit the following 
documents/information as required:

1. [Document 1]
2. [Document 2]
3. [Document 3]

Kindly acknowledge receipt of the same.`}

Thanking you,

Yours faithfully,

For ${clientName}

____________________________
Authorised Signatory

Encl: As above

${'‚ïê'.repeat(60)}
`;
      break;
      
    case 'ADJOURNMENT':
      doc = `
${'‚ïê'.repeat(60)}
            APPLICATION FOR ADJOURNMENT
${'‚ïê'.repeat(60)}

Date: ${today}

To,
The Proper Officer / Assessing Officer
[Jurisdiction/Ward]
[Address]

Subject: Request for Adjournment of Hearing
         Reference: ${ref}

${module === 'GST' ? 'GSTIN' : 'PAN'}: ${idNumber}
Name: ${clientName}

Respected Sir/Madam,

With reference to the above-mentioned proceedings, I/we have been 
called for personal hearing on [Scheduled Date] at [Time].

I/We most respectfully submit that I/we are unable to attend the 
said hearing due to the following reason(s):

${reason || `[State specific reason - e.g., prior commitment, medical emergency, 
authorized representative's non-availability, need more time to 
prepare submissions, etc.]`}

In view of the above, it is most humbly requested that the hearing 
may kindly be adjourned to a convenient date on or after [Suggested Date].

I/We undertake to attend on the next date without seeking any further 
adjournment.

Thanking you,

Yours faithfully,

For ${clientName}

____________________________
Authorised Signatory

${'‚ïê'.repeat(60)}
`;
      break;
      
    case 'RECTIFICATION':
      doc = `
${'‚ïê'.repeat(60)}
         APPLICATION FOR RECTIFICATION
              ${module === 'GST' ? 'Under Section 161 of CGST Act' : 'Under Section 154'}
${'‚ïê'.repeat(60)}

Date: ${today}

To,
The Proper Officer / Assessing Officer
[Jurisdiction/Ward]
[Address]

Subject: Application for Rectification of Mistake Apparent from Record
         Reference: ${ref}

${module === 'GST' ? 'GSTIN' : 'PAN'}: ${idNumber}
Name: ${clientName}

Respected Sir/Madam,

I/We wish to bring to your kind notice that there is a mistake 
apparent from record in the order/intimation dated [Order Date] 
which requires rectification.

PARTICULARS OF MISTAKE:

${reason || `1. Nature of Mistake: [Describe the mistake]

2. Correct Position: [State the correct position]

3. Documentary Evidence: [Reference to supporting documents]

4. Impact of Mistake: [State the consequence if not rectified]`}

PRAYER:

In view of the above, it is most respectfully prayed that the 
aforesaid mistake may kindly be rectified and a revised order/
intimation may be issued.

I/We am/are enclosing the following documents in support:
1. Copy of original order/intimation
2. [Other supporting documents]

Thanking you,

Yours faithfully,

For ${clientName}

____________________________
Authorised Signatory

Encl: As above

${'‚ïê'.repeat(60)}
`;
      break;
      
    case 'CONDONATION':
      doc = `
${'‚ïê'.repeat(60)}
       APPLICATION FOR CONDONATION OF DELAY
${'‚ïê'.repeat(60)}

Date: ${today}

To,
The Proper Officer / Appellate Authority
[Jurisdiction/Ward]
[Address]

Subject: Application for Condonation of Delay in Filing [Appeal/Reply/Return]
         Reference: ${ref}

${module === 'GST' ? 'GSTIN' : 'PAN'}: ${idNumber}
Name: ${clientName}

Respected Sir/Madam,

I/We most respectfully submit this application seeking condonation 
of delay of [X] days in filing [Appeal/Reply/Application].

PARTICULARS:

1. Due Date for Filing: [Date]
2. Actual Date of Filing: [Date]
3. Delay in Filing: [X] days

REASONS FOR DELAY:

${reason || `The delay occurred due to the following unavoidable circumstances:

1. [State specific reason with dates]
2. [Supporting circumstances]
3. [Steps taken to mitigate delay]

The delay was neither intentional nor willful. The applicant had 
sufficient cause for the delay as explained above.`}

PRAYER:

In view of the above submissions, it is most respectfully prayed that:

a) The delay of [X] days may kindly be condoned;
b) The [Appeal/Reply/Application] may be accepted and heard on merits;
c) Any other relief as deemed fit may be granted.

I/We undertake to be regular in complying with future deadlines.

Thanking you,

Yours faithfully,

For ${clientName}

____________________________
Authorised Signatory

Encl:
1. [Delayed document]
2. Supporting documents for delay

${'‚ïê'.repeat(60)}
`;
      break;
      
    case 'REFUND_APP':
      doc = `
${'‚ïê'.repeat(60)}
            REFUND APPLICATION LETTER
       ${module === 'GST' ? 'Under Section 54 of CGST Act' : 'Under Section 237-245'}
${'‚ïê'.repeat(60)}

Date: ${today}

To,
The Proper Officer / Assessing Officer
[Jurisdiction/Ward]
[Address]

Subject: Application for Refund of ${module === 'GST' ? 'GST' : 'Income Tax'}
         Reference: ${ref}

${module === 'GST' ? 'GSTIN' : 'PAN'}: ${idNumber}
Name: ${clientName}

Respected Sir/Madam,

I/We hereby apply for refund of ${module === 'GST' ? 'GST' : 'Income Tax'} as per 
the details mentioned below:

REFUND DETAILS:

${reason || `1. Type of Refund: [Excess payment / Export / Inverted duty / 
                    Accumulated ITC / TDS Refund / Advance Tax]

2. Tax Period/Assessment Year: [Specify]

3. Amount of Refund Claimed: Rs. [Amount]/-

   Breakup:
   - IGST: Rs. [Amount]/-
   - CGST: Rs. [Amount]/-
   - SGST: Rs. [Amount]/-
   - Cess: Rs. [Amount]/-

4. Reason for Refund:
   [Explain the circumstances leading to refund claim]

5. Bank Account Details for Credit:
   - Bank Name: 
   - Branch: 
   - Account Number: 
   - IFSC Code: `}

DECLARATION:

I/We hereby declare that:
a) No refund on this account has been claimed earlier
b) The amount claimed is correct and verifiable from records
c) I/We shall refund the amount if found to be wrongly claimed

DOCUMENTS ENCLOSED:

1. ${module === 'GST' ? 'Form GST RFD-01' : 'Form 30 / Refund Application'}
2. Copies of returns
3. Bank statement
4. [Other supporting documents]

Thanking you,

Yours faithfully,

For ${clientName}

____________________________
Authorised Signatory

${'‚ïê'.repeat(60)}
`;
      break;
  }
  
  document.getElementById('docOutput').textContent = doc;
  showToast('Document generated!', 'success');
}

// Document output functions
function copyDoc() {
  const text = document.getElementById('docOutput').textContent;
  navigator.clipboard.writeText(text).then(() => {
    showToast('Document copied to clipboard!', 'success');
  }).catch(() => {
    showToast('Failed to copy', 'error');
  });
}

function downloadDocTXT() {
  const text = document.getElementById('docOutput').textContent;
  const filename = `Document_${new Date().toISOString().split('T')[0]}.txt`;
  downloadFile(text, filename, 'text/plain');
}

function printDoc() {
  const content = document.getElementById('docOutput').textContent;
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Document</title>
      <style>
        body { 
          font-family: 'Courier New', Courier, monospace; 
          padding: 40px; 
          line-height: 1.6;
          font-size: 12px;
        }
        pre { 
          white-space: pre-wrap; 
          word-wrap: break-word;
          margin: 0;
        }
        @page { margin: 2cm; }
      </style>
    </head>
    <body>
      <pre>${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => printWindow.print(), 500);
}

// ============================================
// TOAST NOTIFICATIONS
// ============================================

function showToast(message, type = 'success') {
  const container = document.getElementById('toastContainer');
  
  // Remove existing toasts
  container.innerHTML = '';
  
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <strong>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚ö†'}</strong>
    ${message}
  `;
  
  container.appendChild(toast);
  
  // Auto remove after 3 seconds
  setTimeout(() => {
    if (toast.parentNode) {
      toast.style.animation = 'slideIn 0.3s ease reverse';
      setTimeout(() => toast.remove(), 300);
    }
  }, 3000);
}

// ============================================
// KEYBOARD SHORTCUTS
// ============================================

document.addEventListener('keydown', function(e) {
  // Ctrl+S to save draft
  if (e.ctrlKey && e.key === 's') {
    e.preventDefault();
    saveAsDraft();
  }
  
  // Ctrl+G to generate reply
  if (e.ctrlKey && e.key === 'g') {
    e.preventDefault();
    generateReply();
  }
  
  // Ctrl+P to print
  if (e.ctrlKey && e.key === 'p') {
    e.preventDefault();
    printPDF();
  }
  
  // Escape to close modal
  if (e.key === 'Escape') {
    closeDraftsModal();
  }
});

// ============================================
// CLICK OUTSIDE TO CLOSE MODAL
// ============================================

document.getElementById('draftsModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeDraftsModal();
  }
});

// ============================================
// FILE UPLOAD HANDLER
// ============================================

document.getElementById('noticeFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  if (file.type === 'text/plain') {
    const reader = new FileReader();
    reader.onload = function(event) {
      document.getElementById('noticeText').value = event.target.result;
      showToast('File loaded! Click "Analyse Notice" to proceed.', 'success');
    };
    reader.readAsText(file);
  } else if (file.type === 'application/pdf') {
    showToast('PDF detected. For best results, copy-paste the text content.', 'warning');
  } else if (file.type.startsWith('image/')) {
    showToast('Image uploaded. Basic OCR not available. Please paste text manually.', 'warning');
  }
});

// ============================================
// WINDOW UNLOAD WARNING
// ============================================

window.addEventListener('beforeunload', function(e) {
  const hasContent = document.getElementById('clientName').value.trim() || 
                     document.getElementById('issues').value.trim();
  
  if (hasContent) {
    autoSaveToLocalStorage();
    // Note: Modern browsers may not show custom message
    e.returnValue = 'You have unsaved data. Are you sure you want to leave?';
    return e.returnValue;
  }
});

// ============================================
// EXPORT FUNCTIONS FOR WINDOW
// ============================================

// Make functions globally accessible
window.toggleTheme = toggleTheme;
window.switchTab = switchTab;
window.toggleCollapsible = toggleCollapsible;
window.handleModuleChange = handleModuleChange;
window.showNoticeInfo = showNoticeInfo;
window.quickSelectNotice = quickSelectNotice;
window.validateField = validateField;
window.validateGSTIN = validateGSTIN;
window.calculateDueDate = calculateDueDate;
window.addAnnexure = addAnnexure;
window.addQuickAnnexure = addQuickAnnexure;
window.removeAnnexure = removeAnnexure;
window.analyseNotice = analyseNotice;
window.clearNoticeImport = clearNoticeImport;
window.generateReply = generateReply;
window.loadSampleData = loadSampleData;
window.resetForm = resetForm;
window.copyToClipboard = copyToClipboard;
window.downloadTXT = downloadTXT;
window.downloadJSON = downloadJSON;
window.downloadHTML = downloadHTML;
window.printPDF = printPDF;
window.saveAsDraft = saveAsDraft;
window.loadSavedDrafts = loadSavedDrafts;
window.closeDraftsModal = closeDraftsModal;
window.loadDraft = loadDraft;
window.deleteDraft = deleteDraft;
window.searchCaseLaws = searchCaseLaws;
window.toggleCaseSelection = toggleCaseSelection;
window.insertSelectedCaseLaws = insertSelectedCaseLaws;
window.browseCaseLaw = browseCaseLaw;
window.addSingleCaseLaw = addSingleCaseLaw;
window.clearCaseSearch = clearCaseSearch;
window.loadCirculars = loadCirculars;
window.searchCirculars = searchCirculars;
window.insertSelectedCircular = insertSelectedCircular;
window.addToMyLibrary = addToMyLibrary;
window.useFromLibrary = useFromLibrary;
window.removeFromLibrary = removeFromLibrary;
window.clearLibrary = clearLibrary;
window.exportLibrary = exportLibrary;
window.importLibrary = importLibrary;
window.generateAuthorization = generateAuthorization;
window.generateUndertaking = generateUndertaking;
window.generatePartnershipDeed = generatePartnershipDeed;
window.generateMiscDoc = generateMiscDoc;
window.copyDoc = copyDoc;
window.downloadDocTXT = downloadDocTXT;
window.printDoc = printDoc;

console.log('TaxReply Pro v2.0 with Case Law Database initialized successfully!');
console.log('Keyboard shortcuts: Ctrl+S (Save), Ctrl+G (Generate), Ctrl+P (Print)');
</script>
</body>
</html>